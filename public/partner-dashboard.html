<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T4L Partner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <style>
      /* Prevent horizontal overflow */
      * {
        box-sizing: border-box;
      }
      
      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }
      
      /* Custom styles for mobile sidebar toggle */
      .sidebar-toggle {
        display: none;
      }
      
      @media (max-width: 768px) {
        .sidebar-toggle {
          display: block;
          position: fixed;
          top: 1rem;
          left: 1rem;
          z-index: 50;
          background: #4b0d7f;
          color: white;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          position: fixed;
          height: 100vh;
          z-index: 40;
        }
        
        .sidebar.active {
          transform: translateX(0);
        }
        
        .overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 30;
        }
        
        .overlay.active {
          display: block;
        }
      }

      /* Line clamp utility */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* FIXED: Carousel container prevents overflow */
      .posts-container {
        position: relative;
        width: 100%;
        overflow: hidden; /* KEY: Prevents cards from overflowing */
      }

      /* FIXED: Proper horizontal scroll */
      .posts-scroll {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
        padding: 0.5rem 0;
        width: 100%;
      }

      .posts-scroll::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      /* FIXED: Scroll button states */
      .scroll-btn {
        transition: all 0.3s ease;
        flex-shrink: 0;
      }

      .scroll-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .scroll-btn:not(:disabled):hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* FIXED: Compact post card with proper sizing */
      .post-card {
        min-width: 300px;
        max-width: 300px;
        flex-shrink: 0; /* KEY: Prevents cards from shrinking */
        transition: all 0.3s ease;
        height: fit-content;
      }

      .post-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(75, 13, 127, 0.15);
      }

      @media (max-width: 640px) {
        .post-card {
          min-width: 280px;
          max-width: 280px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Global Notification Script -->
    <script src="/js/notifications.js"></script>
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="bx bx-menu text-xl"></i>
    </button>
    
    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay"></div>
    
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="sidebar w-20 lg:w-20 md:w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-6 z-40">
        <div class="mb-4">
          <div class="bg-[#4b0d7f] text-white px-3 py-2 rounded-xl font-semibold text-sm">T4L</div>
        </div>
        <nav class="flex flex-col space-y-4 text-gray-700 w-full">
          <a href="/partner-dashboard.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50 bg-purple-50">
            <i class="bx bxs-home text-2xl text-[#4b0d9f] group-hover:scale-110 transition-transform duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-[#4b0d9f] transition-colors duration-200">Home</span>
          </a>
        <!-- ADD THIS NEW SERVICES MENU ITEM -->
        <a href="/services.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
          <i class="bx bx-briefcase-alt-2 text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
          <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Services</span>
        </a>
          <a href="/Partner-Calls.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-line-chart text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Impact Log</span>
          </a>
          <a href="/Partner-Calls.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-briefcase text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Partners</span>
          </a>
          <a href="https://www.t4leader.com/event" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-calendar-event text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Events</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-user text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Profile</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-cog text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Settings</span>
          </a>
          <div id="logoutBtn" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-red-50">
            <i class="bx bx-log-out text-2xl group-hover:text-red-600 group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-red-600 transition-colors duration-200">Logout</span>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-4 md:p-6 lg:p-6 overflow-x-hidden">
        <!-- Top Navbar -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <h1 class="text-xl font-semibold text-gray-900">T4L Partner</h1>
          <div class="flex items-center space-x-4 w-full md:w-auto">
            <div class="relative flex-1 md:flex-none">
              <input
                type="text"
                placeholder="Search articles, events, partners..."
                class="border border-gray-400 rounded-full pl-10 pr-4 py-2 text-sm w-full md:w-80 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              <i class="bx bx-search absolute left-3 top-2.5 text-gray-900"></i>
            </div>
            <div class="flex items-center space-x-2">
              <i class="bx bx-bell text-2xl text-gray-900"></i>
              <div class="w-10 h-10 bg-[#4b0d7f] flex items-center justify-center rounded-full font-bold text-white">
                DL
              </div>
            </div>
          </div>
        </header>

        <!-- Hero Section -->
        <section class="bg-gradient-to-r from-[#4b0d7f] to-[#a36737] text-white p-6 md:p-8 rounded-2xl mb-6 shadow-md relative overflow-hidden">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl md:text-3xl font-bold mb-2" id="welcomeHeading">Welcome back, Partner!</h2>
              <p class="text-sm md:text-base opacity-90">
                CHANGE :2 new applications waiting for your review
              </p>
            </div>
            
            <a href="/creat-Post.html" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 px-6 py-3 rounded-xl shadow-sm hover:shadow-md transition-all flex items-center gap-2 font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
              </svg>
              <span>Create a Post</span>
            </a>
          </div>
        </section>

        <!-- LIFT Pillar Section -->
        <section class="bg-white p-6 md:p-8 rounded-2xl mb-6 shadow-md">
          <h2 class="text-xl font-bold mb-5">LIFT Pillar</h2>
          
          <!-- Dropdown -->
          <div class="relative mb-6">
            <select class="w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-700 text-base appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
              <option>Leading Self</option>
              <option>Inspiring Others</option>
              <option>Fostering Teams</option>
              <option>Transforming Orgs</option>
            </select>
            <svg class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-700 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <!-- Visibility Opportunities -->
          <h3 class="text-lg font-bold mb-4">Visibility Opportunities</h3>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <button 
              onclick="setActive(this)" 
              class="opportunity-btn active bg-[#4b0d7f] text-white px-5 py-4 rounded-xl shadow-md hover:shadow-lg transition-all font-semibold text-base"
            >
              Speaking
            </button>
            <button 
              onclick="setActive(this)" 
              class="opportunity-btn bg-gray-300 text-black px-5 py-4 rounded-xl shadow-md hover:shadow-lg transition-all font-semibold text-base"
            >
              Podcast
            </button>
            <button 
              onclick="setActive(this)" 
              class="opportunity-btn bg-gray-300 text-black px-5 py-4 rounded-xl shadow-md hover:shadow-lg transition-all font-semibold text-base"
            >
              Webinar
            </button>
            <button 
              onclick="setActive(this)" 
              class="opportunity-btn bg-gray-300 text-black px-5 py-4 rounded-xl shadow-md hover:shadow-lg transition-all font-semibold text-base"
            >
              Volunteering
            </button>
          </div>
        </section>

        <!-- Stats Section -->
        <section class="mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Total Views Card -->
            <div class="bg-white border border-purple-300 rounded-2xl p-5 shadow hover:shadow-lg transition-all hover:-translate-y-1 hover:border-purple-500 cursor-pointer">
              <div class="flex justify-center mb-3">
                <div class="rounded-xl p-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-purple-800" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10M14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 mb-1" id="totalViews">0</p>
                <p class="text-sm text-gray-600 font-medium">Total Views</p>
              </div>
            </div>

            <!-- Pending Review Card -->
            <div class="bg-white border border-yellow-300 rounded-2xl p-5 shadow hover:shadow-lg transition-all hover:-translate-y-1 hover:border-yellow-500 cursor-pointer">
              <div class="flex justify-center mb-3">
                <div class="rounded-xl p-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 mb-1" id="pendingApplications">0</p>
                <p class="text-sm text-gray-600 font-medium">Pending Review</p>
              </div>
            </div>

            <!-- Active Posts Card -->
            <div class="bg-white border border-purple-300 rounded-2xl p-5 shadow hover:shadow-lg transition-all hover:-translate-y-1 hover:border-purple-500 cursor-pointer">
              <div class="flex justify-center mb-3">
                <div class="rounded-xl p-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-purple-800" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                  </svg>
                </div>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 mb-1" id="activePosts">0</p>
                <p class="text-sm text-gray-600 font-medium">Active Posts</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent Applications Section -->
        <section class="bg-white rounded-2xl p-6 md:p-8 mb-6 shadow-md">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Recent Applications</h2>
              <p class="text-sm text-gray-600 mt-1">Review ambassador applications for your opportunities</p>
            </div>
            <a href="/applications.html" class="text-purple-600 hover:text-purple-700 font-semibold text-sm hover:underline">
              View All ‚Üí
            </a>
          </div>

          <div id="applicationsContainer">
            <!-- Applications will be loaded here -->
            <div class="text-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
              <p class="text-gray-600">Loading applications...</p>
            </div>
          </div>
        </section>

        <!-- Posts Section - FIXED CAROUSEL -->
        <section class="bg-white rounded-2xl p-6 md:p-8 mb-6 shadow-md">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Your Posts</h2>
              <p class="text-sm text-gray-600 mt-1">Manage your visibility opportunities</p>
            </div>
            <div class="flex gap-2">
              <button id="scrollLeftBtn" class="scroll-btn bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-full p-2.5 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <button id="scrollRightBtn" class="scroll-btn bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-full p-2.5 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </div>

          <!-- FIXED: Carousel Container -->
          <div class="posts-container">
            <div id="postsScroll" class="posts-scroll">
              <!-- Loading State -->
              <div class="min-w-full flex items-center justify-center py-12">
                <div class="text-center">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                  <p class="text-gray-600">Loading your posts...</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // ============================================
      // FIXED: Load and display posts for partner dashboard
      // ============================================
      function loadPosts() {
        console.log('üîç Fetching posts for partner dashboard...');
        
        // ‚úÖ Don't pass any ID - the endpoint uses the session
        fetch('/api/partner/posts')
          .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Posts data received:', data);
            const postsContainer = document.getElementById('postsScroll');
            
            if (!postsContainer) {
              console.error('‚ùå Posts container not found');
              return;
            }

            // Clear existing content
            postsContainer.innerHTML = '';

            const myPosts = data.posts || [];
            console.log(`üìä Found ${myPosts.length} posts for this partner`);

            if (myPosts.length > 0) {
              // Update stats
              const activePostsElement = document.getElementById('activePosts');
              if (activePostsElement) {
                activePostsElement.textContent = myPosts.length;
              }
              
              const totalViews = myPosts.reduce((sum, post) => sum + (post.views || 0), 0);
              const totalViewsElement = document.getElementById('totalViews');
              if (totalViewsElement) {
                totalViewsElement.textContent = totalViews;
              }

              // Create cards
              myPosts.forEach((post, index) => {
                console.log(`Creating card ${index + 1}:`, post.title);
                const postCard = createPostCard(post);
                postsContainer.appendChild(postCard);
              });
              
              // Update scroll buttons after loading posts
              setTimeout(() => {
                const scrollContainer = document.getElementById('postsScroll');
                if (scrollContainer) {
                  const event = new Event('scroll');
                  scrollContainer.dispatchEvent(event);
                }
              }, 200);
            } else {
              console.log('üì≠ No posts found, showing empty state');
              // Show empty state
              postsContainer.innerHTML = `
                <div class="min-w-full border-2 border-dashed border-gray-300 rounded-2xl p-8 flex flex-col items-center justify-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <h3 class="text-base font-bold text-gray-900 mb-1">No posts yet</h3>
                  <p class="text-sm text-gray-600 mb-3">Create your first post to start attracting ambassadors</p>
                  <a href="/creat-Post.html" class="bg-gradient-to-r from-[#4b0d7f] to-[#6b1fa0] text-white px-5 py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm">
                    Create Post
                  </a>
                </div>
              `;
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading posts:', error);
            const postsContainer = document.getElementById('postsScroll');
            if (postsContainer) {
              postsContainer.innerHTML = `
                <div class="min-w-full border-2 border-red-300 rounded-2xl p-8 flex flex-col items-center justify-center text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h3 class="text-base font-bold text-gray-900 mb-1">Error loading posts</h3>
                  <p class="text-sm text-gray-600 mb-3">${error.message}</p>
                  <button onclick="loadPosts()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-purple-700 transition-all text-sm">
                    Retry
                  </button>
                </div>
              `;
            }
          });
      }

      // ============================================
      // Helper function to format time ago
      // ============================================
      function timeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
      }

      // ============================================
      // Get post type icon
      // ============================================
      function getPostTypeIcon(postType) {
        const icons = {
          'speaking': `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>`,
          'podcast': `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
          </svg>`,
          'webinar': `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M21 3H3c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.11-.9-2-2-2zm0 14H3V5h18v12z"/>
            <path d="M9 8l7 4-7 4z"/>
          </svg>`,
          'volunteering': `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>`
        };
        return icons[postType.toLowerCase()] || icons['speaking'];
      }

      // ============================================
      // Get post type color
      // ============================================
      function getPostTypeColor(postType) {
        const colors = {
          'speaking': { bg: 'bg-purple-500', text: 'text-purple-700', light: 'bg-purple-100' },
          'podcast': { bg: 'bg-amber-500', text: 'text-amber-700', light: 'bg-amber-100' },
          'webinar': { bg: 'bg-sky-500', text: 'text-sky-700', light: 'bg-sky-100' },
          'volunteering': { bg: 'bg-pink-500', text: 'text-pink-700', light: 'bg-pink-100' }
        };
        return colors[postType.toLowerCase()] || colors['speaking'];
      }

      // ============================================
      // Create post card HTML - COMPACT VERSION
      // ============================================
      function createPostCard(post) {
        const card = document.createElement('div');
        card.className = 'post-card border-2 border-gray-200 rounded-xl p-4 hover:border-purple-400 bg-white';
        
        const color = getPostTypeColor(post.category || 'general');
        const icon = getPostTypeIcon(post.category || 'general');
        const createdDate = new Date(post.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        card.innerHTML = `
          <!-- Header -->
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg ${color.bg} flex items-center justify-center flex-shrink-0">
                ${icon}
              </div>
              <span class="text-xs font-bold text-gray-600">${createdDate}</span>
            </div>
            <div class="flex gap-1">
              <button class="text-gray-500 hover:text-red-600 p-1 hover:bg-red-50 rounded transition-all" onclick="deletePost('${post.post_id}')" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 011.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Title -->
          <h4 class="text-base font-bold text-gray-900 mb-2 line-clamp-2">${escapeHtml(post.title)}</h4>
          
          <!-- Description -->
          <p class="text-xs text-gray-600 mb-3 line-clamp-3">${escapeHtml(post.content)}</p>
          
          <!-- Tags -->
          <div class="flex flex-wrap gap-1.5 mb-3">
            <span class="${color.light} ${color.text} px-2.5 py-1 rounded-lg text-xs font-semibold capitalize">${post.category || 'General'}</span>
          </div>
          
          <!-- Stats Footer -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-200">
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-1 text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <span class="font-medium text-xs">${post.views || 0}</span>
              </div>
            </div>
            
            <!-- FIXED: Changed from "View All" link to "View Applications" button -->
            <button onclick="viewPostApplications('${post.post_id}')" 
                    class="text-purple-600 hover:text-purple-700 font-semibold text-sm hover:underline">
              View Applications ‚Üí
            </button>
          </div>
        `;
        
        return card;
      }

      // ============================================
      // Helper function to escape HTML
      // ============================================
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ============================================
      // Delete post function
      // ============================================
      function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post?')) {
          return;
        }
        
        fetch(`/api/posts/${postId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white rounded-xl shadow-2xl p-4 z-50';
            notification.innerHTML = `
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <div>
                  <h4 class="font-bold text-gray-900">Post Deleted</h4>
                  <p class="text-sm text-gray-600">Your post has been removed</p>
                </div>
              </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            
            // Reload posts
            loadPosts();
          } else {
            throw new Error('Failed to delete post');
          }
        })
        .catch(error => {
          console.error('Error deleting post:', error);
          alert('Failed to delete post. Please try again.');
        });
      }

      // ============================================
      // View applications for a specific post
      // ============================================
      function viewPostApplications(postId) {
        window.location.href = `/applications.html?postId=${postId}`;
      }

      // ============================================
      // Load recent applications for partner
      // ============================================
      function loadRecentApplications() {
        console.log('üîç Loading applications...');
        
        fetch('/api/partner/applications?limit=20')
          .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Applications data:', data);
            
            const container = document.getElementById('applicationsContainer');
            
            if (!container) {
              console.error('‚ùå Applications container not found');
              return;
            }

            // Update pending applications count in stats
            const pendingCount = data.items ? data.items.filter(app => app.status === 'pending').length : 0;
            const pendingElement = document.getElementById('pendingApplications');
            if (pendingElement) {
              pendingElement.textContent = pendingCount;
            }

            // Show only the 5 most recent applications
            const recentApplications = data.items ? data.items.slice(0, 5) : [];

            if (recentApplications.length > 0) {
              container.innerHTML = recentApplications.map(application => `
                <div class="border border-gray-200 rounded-xl p-4 mb-4 hover:border-purple-300 transition-colors">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-[#4b0d7f] rounded-full flex items-center justify-center text-white font-semibold text-sm">
                        ${application.ambassadorName ? application.ambassadorName.charAt(0).toUpperCase() : 'A'}
                      </div>
                      <div>
                        <h4 class="font-bold text-gray-900">${application.ambassadorName || 'Unknown Ambassador'}</h4>
                        <p class="text-sm text-gray-600">Applied for ${application.postTitle || 'Opportunity'}</p>
                      </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                      application.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                      application.status === 'accepted' ? 'bg-green-100 text-green-800' :
                      application.status === 'rejected' ? 'bg-red-100 text-red-800' :
                      'bg-blue-100 text-blue-800'
                    }">
                      ${application.status ? application.status.charAt(0).toUpperCase() + application.status.slice(1) : 'Pending'}
                    </span>
                  </div>
                  
                  <div class="flex items-center justify-between text-sm text-gray-600">
                    <span>${new Date(application.appliedAt).toLocaleDateString()}</span>
                    <div class="flex gap-2">
                      ${application.ambassadorProfile && application.ambassadorProfile.cvFilename ? `
                        <a href="/uploads/cvs/${application.ambassadorProfile.cvFilename}" 
                           target="_blank" 
                           class="text-purple-600 hover:text-purple-700 font-semibold hover:underline">
                          View CV
                        </a>
                      ` : ''}
                      <button onclick="viewApplication('${application.id}')" 
                              class="text-purple-600 hover:text-purple-700 font-semibold hover:underline">
                        Review
                      </button>
                    </div>
                  </div>
                </div>
              `).join('');
            } else {
              showEmptyApplicationsState(container);
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading applications:', error);
            const container = document.getElementById('applicationsContainer');
            if (container) {
              showEmptyApplicationsState(container);
            }
          });
      }

      // ============================================
      // Helper function to show empty applications state
      // ============================================
      function showEmptyApplicationsState(container) {
        container.innerHTML = `
          <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-xl">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">No applications yet</h3>
            <p class="text-sm text-gray-600 mb-4">Applications from ambassadors will appear here once they start applying to your posts</p>
          </div>
        `;
      }

      function viewApplication(applicationId) {
        window.location.href = `/application-details.html?id=${applicationId}`;
      }

      // ============================================
      // FIXED: DOM Content Loaded
      // ============================================
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Partner Dashboard initializing...');
        
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');

        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
          });
        }

        if (overlay) {
          overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
          });
        }

        // **FIXED CAROUSEL SCROLL FUNCTIONALITY**
        const scrollContainer = document.getElementById('postsScroll');
        const scrollLeftBtn = document.getElementById('scrollLeftBtn');
        const scrollRightBtn = document.getElementById('scrollRightBtn');

        function updateScrollButtons() {
          if (!scrollContainer) return;
          
          const isAtStart = scrollContainer.scrollLeft <= 10;
          const isAtEnd = scrollContainer.scrollLeft >= scrollContainer.scrollWidth - scrollContainer.clientWidth - 10;
          
          scrollLeftBtn.disabled = isAtStart;
          scrollRightBtn.disabled = isAtEnd;
        }

        if (scrollContainer && scrollLeftBtn && scrollRightBtn) {
          scrollLeftBtn.addEventListener('click', () => {
            const cardWidth = 300 + 16; // card width + gap
            scrollContainer.scrollBy({ left: -cardWidth, behavior: 'smooth' });
            setTimeout(updateScrollButtons, 400);
          });

          scrollRightBtn.addEventListener('click', () => {
            const cardWidth = 300 + 16;
            scrollContainer.scrollBy({ left: cardWidth, behavior: 'smooth' });
            setTimeout(updateScrollButtons, 400);
          });

          scrollContainer.addEventListener('scroll', updateScrollButtons);
          
          // Initial update
          setTimeout(updateScrollButtons, 100);
        }

        // Fetch and display user data
        fetch('/api/me')
          .then(response => {
            if (!response.ok) {
              throw new Error('Not authenticated');
            }
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ User data loaded:', data);
            
            // Update the welcome message
            const welcomeHeading = document.getElementById('welcomeHeading');
            if (welcomeHeading && data.name) {
              welcomeHeading.textContent = `Welcome back, ${data.name}!`;
            }
            
            // Update the avatar initials
            const avatarElement = document.querySelector('.w-10.h-10.bg-\\[\\#4b0d7f\\]');
            if (avatarElement && data.name) {
              const initials = data.name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
              avatarElement.textContent = initials;
            }

            // ‚úÖ FIXED: Load posts without passing any ID
            console.log('üì• Loading posts...');
            loadPosts();  // No ID parameter needed
            
            console.log('üì• Loading applications...');
            loadRecentApplications();
          })
          .catch(error => {
            console.error('‚ùå Error fetching user data:', error);
            window.location.href = '/partner-signin';
          });

        // Visibility opportunities active state
        function setActive(button) {
          document.querySelectorAll('.opportunity-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-[#4b0d7f]', 'text-white');
            btn.classList.add('bg-gray-300', 'text-black');
          });
          
          button.classList.add('active', 'bg-[#4b0d7f]', 'text-white');
          button.classList.remove('bg-gray-300', 'text-black');
        }
        
        window.setActive = setActive;

        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            fetch('/logout', { method: 'POST' })
              .then(() => {
                window.location.href = '/partner-signin';
              })
              .catch(error => {
                console.error('Logout error:', error);
                window.location.href = '/partner-signin';
              });
          });
        }

        // Check for success parameter in URL (from post creation)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success')) {
          console.log('üéâ Post created successfully, refreshing posts...');
          // Force reload posts to show the new one
          setTimeout(loadPosts, 500);
        }
      });

      // ============================================
      // Make functions available globally
      // ============================================
      window.deletePost = deletePost;
      window.viewApplication = viewApplication;
      window.viewPostApplications = viewPostApplications;
      window.loadPosts = loadPosts;
    </script>
  </body>
</html>