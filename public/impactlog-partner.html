<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Log | T4L Partner</title>
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link rel="stylesheet" href="css/styles.css" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
      :root {
        --primary: #4b0d7f;
        --primary-light: #7c3aed;
        --primary-bg: #f5f3ff;
        --amber: #f59e0b;
        --success: #10b981;
        --danger: #ef4444;
      }
      body { background: linear-gradient(135deg, #f5f3ff 0%, #fdf2f8 50%, #faf5ff 100%); min-height: 100vh; }

      /* Partner Sidebar */
      .partner-sidebar {
        width: 80px; background: white; box-shadow: 2px 0 12px rgba(0,0,0,0.08);
        display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0;
        position: sticky; top: 0; height: 100vh; overflow-y: auto; flex-shrink: 0;
      }
      .partner-sidebar-logo { background: #4b0d7f; color: white; padding: 0.5rem 0.75rem; border-radius: 0.75rem; font-weight: 700; font-size: 0.875rem; margin-bottom: 1.5rem; }
      .partner-sidebar-nav { display: flex; flex-direction: column; gap: 0.25rem; width: 100%; padding: 0 0.5rem; flex: 1; }
      .partner-nav-link { display: flex; flex-direction: column; align-items: center; padding: 0.625rem 0.5rem; border-radius: 0.625rem; text-decoration: none; cursor: pointer; transition: all 0.2s; color: #6b7280; }
      .partner-nav-link:hover { background: rgba(75,13,127,0.08); color: #4b0d9f; }
      .partner-nav-link.active { background: rgba(75,13,127,0.1); color: #4b0d9f; }
      .partner-nav-link i { font-size: 1.5rem; transition: transform 0.2s; }
      .partner-nav-link:hover i { transform: scale(1.1); }
      .partner-nav-link span { font-size: 0.625rem; margin-top: 0.375rem; font-weight: 500; text-align: center; line-height: 1.2; }
      .partner-nav-link.logout:hover { background: rgba(239,68,68,0.1); color: #dc2626; }
      .partner-nav-spacer { flex: 1; }
      .partner-sidebar-toggle { display: none; }

      @media (max-width: 768px) {
        .partner-sidebar-toggle { display: flex; position: fixed; top: 1rem; left: 1rem; z-index: 50; background: #4b0d7f; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(75,13,127,0.3); cursor: pointer; }
        .partner-sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 45; }
        .partner-sidebar.active { transform: translateX(0); }
        .partner-sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        .partner-sidebar-overlay.active { display: block; }
      }

      /* Stat Cards */
      .impact-stat-card { background: white; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #f3f4f6; transition: all 0.3s ease; }
      .impact-stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(75,13,127,0.1); }

      /* Tabs */
      .tab-btn { padding: 0.625rem 1.25rem; border-radius: 0.625rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; background: white; color: #6b7280; }
      .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
      .tab-btn:not(.active):hover { background: #f5f3ff; color: var(--primary); border-color: #e9d5ff; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* Cards */
      .event-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #f3f4f6; transition: all 0.3s; }
      .event-card:hover { box-shadow: 0 8px 25px rgba(75,13,127,0.08); }
      .entry-card { background: white; border-radius: 0.75rem; padding: 1.25rem; border: 1px solid #f3f4f6; transition: all 0.2s; }
      .entry-card:hover { border-color: #e9d5ff; }

      /* Badges */
      .badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
      .badge-open { background: #d1fae5; color: #065f46; }
      .badge-closed { background: #fee2e2; color: #991b1b; }
      .badge-env { background: #d1fae5; color: #065f46; }
      .badge-social { background: #dbeafe; color: #1e40af; }
      .badge-gov { background: #fef3c7; color: #92400e; }

      /* Modal */
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); }
      .modal-overlay.active { display: flex; }
      .modal-content { background: white; border-radius: 1.5rem; width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.15); animation: slideUp 0.3s ease; }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

      /* Form */
      .form-label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem; }
      .form-input, .form-select, .form-textarea { width: 100%; padding: 0.625rem 0.875rem; border: 1.5px solid #d1d5db; border-radius: 0.625rem; font-size: 0.875rem; transition: all 0.2s; outline: none; box-sizing: border-box; }
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(75,13,127,0.1); }

      /* Buttons */
      .btn-primary { background: linear-gradient(135deg, #4b0d7f, #6b21a8); color: white; padding: 0.625rem 1.5rem; border-radius: 0.625rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
      .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(75,13,127,0.3); }
      .btn-secondary { background: white; color: #4b0d7f; padding: 0.625rem 1.5rem; border-radius: 0.625rem; font-weight: 600; border: 2px solid #e9d5ff; cursor: pointer; transition: all 0.2s; }
      .btn-secondary:hover { background: #f5f3ff; border-color: #4b0d7f; }
      .btn-danger { background: #fee2e2; color: #dc2626; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
      .btn-danger:hover { background: #fecaca; }
      .btn-sm { padding: 0.375rem 0.875rem; font-size: 0.8rem; }

      /* Share */
      .share-panel { background: #fefce8; border: 1px solid #fef08a; border-radius: 1rem; padding: 1.25rem; }
      .share-btn { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
      .share-btn:hover { transform: translateY(-1px); }
      .share-linkedin { background: #0077b5; color: white; }
      .share-x { background: #000; color: white; }
      .share-copy { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

      /* QR */
      .qr-container { background: white; border: 2px solid #e9d5ff; border-radius: 1rem; padding: 1.5rem; text-align: center; }

      /* Empty state */
      .empty-state { text-align: center; padding: 3rem 1rem; }
      .empty-icon { width: 80px; height: 80px; background: #f5f3ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; }

      /* Loader */
      .spinner { width: 20px; height: 20px; border: 2.5px solid #e9d5ff; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
      @keyframes spin { to { transform: rotate(360deg); } }

      @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr) !important; } }
    </style>
</head>
<body class="font-sans">
    <script src="/js/notifications.js"></script>

    <!-- Mobile Toggle -->
    <button class="partner-sidebar-toggle" id="sidebarToggle"><i class="bx bx-menu text-xl"></i></button>
    <div class="partner-sidebar-overlay" id="sidebarOverlay"></div>

    <div class="flex min-h-screen">
      <!-- Partner Sidebar -->
      <aside class="partner-sidebar" id="partnerSidebar">
        <div class="partner-sidebar-logo">T4L</div>
        <nav class="partner-sidebar-nav">
          <a href="/partner-dashboard.html" class="partner-nav-link"><i class="bx bxs-home"></i><span>Home</span></a>
          <a href="/creat-Post.html" class="partner-nav-link"><i class="bx bx-plus-circle"></i><span>Create Post</span></a>
          <a href="/my-services.html" class="partner-nav-link"><i class="bx bx-briefcase-alt-2"></i><span>Services</span></a>
          <a href="/applications.html" class="partner-nav-link"><i class="bx bx-file"></i><span>Applications</span></a>
          <a href="/impactlog-partner.html" class="partner-nav-link active"><i class="bx bx-line-chart"></i><span>Impact Log</span></a>
          <a href="/feedback-support-partner.html" class="partner-nav-link"><i class="bx bx-help-circle"></i><span>Feedback</span></a>
          <a href="/chat-pillar-partner.html" class="partner-nav-link"><i class="bx bxs-group"></i><span>T4L Ecosystem</span></a>
          <a href="https://www.t4leader.com/event" class="partner-nav-link" target="_blank" rel="noopener noreferrer"><i class="bx bx-calendar-event"></i><span>Events</span></a>
          <a href="/profile-partner.html" class="partner-nav-link"><i class="bx bx-user"></i><span>Profile</span></a>
          <div class="partner-nav-spacer"></div>
          <div class="partner-nav-link logout" id="logoutBtn"><i class="bx bx-log-out"></i><span>Logout</span></div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-4 md:p-6 lg:p-8 max-w-6xl">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
          <div>
            <a href="/partner-dashboard.html" class="inline-flex items-center text-gray-500 hover:text-purple-700 mb-2 text-sm font-medium transition-all">
              <i class="bx bx-arrow-back mr-1"></i> Back to Dashboard
            </a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Partner Impact Log</h1>
            <p class="text-gray-500 text-sm mt-1">Create events, track impact, and grow your community contribution</p>
          </div>
          <div class="flex gap-3">
            <button onclick="openModal('createEntryModal')" class="btn-secondary text-sm flex items-center gap-2">
              <i class="bx bx-plus-circle"></i> Log Impact
            </button>
            <button onclick="openModal('createEventModal')" class="btn-primary text-sm flex items-center gap-2">
              <i class="bx bx-calendar-plus"></i> Create Shared Event
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
          <div class="impact-stat-card">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="bx bx-group text-purple-600 text-xl"></i></div>
              <div><p class="text-xs text-gray-500 font-medium">People Impacted</p><p class="text-xl font-bold text-gray-900" id="statPeople">0</p></div>
            </div>
          </div>
          <div class="impact-stat-card">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="bx bx-time-five text-blue-600 text-xl"></i></div>
              <div><p class="text-xs text-gray-500 font-medium">Hours Contributed</p><p class="text-xl font-bold text-gray-900" id="statHours">0</p></div>
            </div>
          </div>
          <div class="impact-stat-card">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="bx bx-dollar text-green-600 text-xl"></i></div>
              <div><p class="text-xs text-gray-500 font-medium">USD Value</p><p class="text-xl font-bold text-gray-900" id="statUsd">$0</p></div>
            </div>
          </div>
          <div class="impact-stat-card">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="bx bx-trophy text-amber-600 text-xl"></i></div>
              <div><p class="text-xs text-gray-500 font-medium">SCP Earned</p><p class="text-xl font-bold text-gray-900" id="statScp">0</p></div>
            </div>
          </div>
          <div class="impact-stat-card">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center flex-shrink-0"><i class="bx bx-calendar-event text-pink-600 text-xl"></i></div>
              <div><p class="text-xs text-gray-500 font-medium">Events Created</p><p class="text-xl font-bold text-gray-900" id="statEvents">0</p></div>
            </div>
          </div>
        </div>

        <!-- Share My Impact & Export Report Buttons -->
        <div class="mb-6 flex gap-3 flex-wrap">
          <button onclick="openShareMyImpact()" class="btn-secondary text-sm flex items-center gap-2">
            <i class="bx bx-share-alt"></i> Share My Impact
          </button>
          <button onclick="exportImpactReport()" class="btn-secondary text-sm flex items-center gap-2">
            <i class="bx bx-download"></i> Export Impact Report
          </button>
        </div>

        <!-- Tabs -->
        <div class="tab-container flex gap-2 mb-6 overflow-x-auto pb-2">
          <button class="tab-btn active" data-tab="events">Shared Impact Events</button>
          <button class="tab-btn" data-tab="entries">My Impact Entries</button>
        </div>

        <!-- Tab: Shared Impact Events -->
        <div id="tab-events" class="tab-content active">
          <div id="eventsLoading" class="text-center py-8"><div class="spinner"></div><p class="text-gray-500 mt-2 text-sm">Loading events...</p></div>
          <div id="eventsList" class="space-y-4" style="display:none;"></div>
          <div id="eventsEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon"><i class="bx bx-calendar-plus text-3xl text-purple-400"></i></div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Shared Impact Events Yet</h3>
            <p class="text-gray-500 text-sm mb-4">Create your first shared impact event and invite the community to participate.</p>
            <button onclick="openModal('createEventModal')" class="btn-primary text-sm">Create Your First Event</button>
          </div>
        </div>

        <!-- Tab: My Impact Entries -->
        <div id="tab-entries" class="tab-content">
          <div id="entriesLoading" class="text-center py-8"><div class="spinner"></div><p class="text-gray-500 mt-2 text-sm">Loading entries...</p></div>
          <div id="entriesList" class="space-y-3" style="display:none;"></div>
          <div id="entriesEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon"><i class="bx bx-line-chart text-3xl text-purple-400"></i></div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Impact Entries Yet</h3>
            <p class="text-gray-500 text-sm mb-4">Start tracking your organization's impact.</p>
            <button onclick="openModal('createEntryModal')" class="btn-primary text-sm">Log Your First Impact</button>
          </div>
        </div>
      </main>
    </div>

    <!-- ===== CREATE SHARED IMPACT EVENT MODAL ===== -->
    <div id="createEventModal" class="modal-overlay">
      <div class="modal-content">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-gray-900">Create Shared Impact Event</h2>
            <p class="text-sm text-gray-500 mt-1">Create a public event for others to log their participation</p>
          </div>
          <button onclick="closeModal('createEventModal')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="bx bx-x text-xl text-gray-500"></i></button>
        </div>
        <form id="createEventForm" class="p-6 space-y-4">
          <div>
            <label class="form-label">Event Title *</label>
            <input type="text" name="title" class="form-input" placeholder="e.g. ESG Training Workshop for SMEs" required>
          </div>
          <div>
            <label class="form-label">Description *</label>
            <textarea name="description" class="form-textarea" rows="3" placeholder="Describe the event and its purpose..." required></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="form-label">ESG Category *</label>
              <select name="esg_category" class="form-select" required>
                <option value="">Select category</option>
                <option value="environmental">Environmental</option>
                <option value="social">Social</option>
                <option value="governance">Governance</option>
              </select>
            </div>
            <div>
              <label class="form-label">Event Date *</label>
              <input type="date" name="event_date" class="form-input" required>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div><label class="form-label">Start Time *</label><input type="time" name="start_time" class="form-input" required></div>
            <div><label class="form-label">End Time *</label><input type="time" name="end_time" class="form-input" required></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="form-label">Total Impact Value *</label><input type="number" name="total_impact_value" class="form-input" placeholder="e.g. 500" min="0" step="any" required></div>
            <div><label class="form-label">Impact Unit *</label><input type="text" name="impact_unit" class="form-input" placeholder="e.g. people, hours, items" value="people" required></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="form-label">Hours Contributed</label><input type="number" name="hours_contributed" class="form-input" placeholder="Optional" min="0" step="any"></div>
            <div><label class="form-label">USD Value Created/Saved</label><input type="number" name="usd_value" class="form-input" placeholder="Optional" min="0" step="any"></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="form-label">Expected Participants</label><input type="number" name="expected_participants" class="form-input" placeholder="Optional" min="0"></div>
            <div><label class="form-label">External Verifier Email</label><input type="email" name="external_verifier_email" class="form-input" placeholder="Optional"></div>
          </div>
          <div><label class="form-label">Evidence Link</label><input type="url" name="evidence_link" class="form-input" placeholder="https://... (optional)"></div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" onclick="closeModal('createEventModal')" class="btn-secondary text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm flex items-center gap-2" id="createEventBtn"><span>Create Event</span><div class="spinner hidden" id="createEventSpinner"></div></button>
          </div>
        </form>
      </div>
    </div>

    <!-- ===== CREATE INDIVIDUAL IMPACT ENTRY MODAL ===== -->
    <div id="createEntryModal" class="modal-overlay">
      <div class="modal-content">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-gray-900">Log Impact Entry</h2>
            <p class="text-sm text-gray-500 mt-1">Record an individual impact activity</p>
          </div>
          <button onclick="closeModal('createEntryModal')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="bx bx-x text-xl text-gray-500"></i></button>
        </div>
        <form id="createEntryForm" class="p-6 space-y-4">
          <div><label class="form-label">Title *</label><input type="text" name="title" class="form-input" placeholder="e.g. Corporate sustainability workshop" required></div>
          <div><label class="form-label">Description</label><textarea name="description" class="form-textarea" rows="3" placeholder="What did your organization do?"></textarea></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="form-label">ESG Category *</label>
              <select name="esg_category" class="form-select" required>
                <option value="">Select category</option>
                <option value="environmental">Environmental</option>
                <option value="social">Social</option>
                <option value="governance">Governance</option>
              </select>
            </div>
            <div><label class="form-label">Activity Date</label><input type="date" name="activity_date" class="form-input"></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="form-label">People Impacted</label><input type="number" name="people_impacted" class="form-input" placeholder="0" min="0" step="any"></div>
            <div><label class="form-label">Hours Contributed</label><input type="number" name="hours_contributed" class="form-input" placeholder="0" min="0" step="any"></div>
            <div><label class="form-label">USD Value</label><input type="number" name="usd_value" class="form-input" placeholder="0" min="0" step="any"></div>
          </div>
          <div><label class="form-label">Evidence Link</label><input type="url" name="evidence_link" class="form-input" placeholder="https://... (optional)"></div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" onclick="closeModal('createEntryModal')" class="btn-secondary text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm flex items-center gap-2" id="createEntryBtn"><span>Log Impact</span><div class="spinner hidden" id="createEntrySpinner"></div></button>
          </div>
        </form>
      </div>
    </div>

    <!-- ===== EVENT DETAIL MODAL ===== -->
    <div id="eventDetailModal" class="modal-overlay">
      <div class="modal-content">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <h2 class="text-xl font-bold text-gray-900" id="detailEventTitle">Event Details</h2>
          <button onclick="closeModal('eventDetailModal')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="bx bx-x text-xl text-gray-500"></i></button>
        </div>
        <div class="p-6" id="eventDetailContent"></div>
      </div>
    </div>

    <!-- ===== SHARE MY IMPACT MODAL ===== -->
    <div id="shareMyImpactModal" class="modal-overlay">
      <div class="modal-content">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <div><h2 class="text-xl font-bold text-gray-900">Share My Impact</h2><p class="text-sm text-gray-500 mt-1">Share your organization's impact snapshot</p></div>
          <button onclick="closeModal('shareMyImpactModal')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="bx bx-x text-xl text-gray-500"></i></button>
        </div>
        <div class="p-6" id="shareMyImpactContent"></div>
      </div>
    </div>

    <script src="/signin.js"></script>
    <script>
    // ============================================
    // IMPACT LOG - PARTNER FRONTEND
    // ============================================
    let myStats = {};
    let myEvents = [];
    let myEntries = [];

    document.addEventListener('DOMContentLoaded', function() {
      requireAuth('/partner-signin');

      // Sidebar toggle
      const toggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('partnerSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (toggle && sidebar && overlay) {
        toggle.addEventListener('click', () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); });
        overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });
      }

      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          fetch('/api/logout', { method: 'POST', credentials: 'include' })
            .then(() => { window.location.href = '/partner-signin'; })
            .catch(() => { window.location.href = '/partner-signin'; });
        });
      }

      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // Forms
      document.getElementById('createEventForm').addEventListener('submit', handleCreateEvent);
      document.getElementById('createEntryForm').addEventListener('submit', handleCreateEntry);

      // Load data
      loadStats();
      loadEvents();
      loadEntries();
    });

    function openModal(id) { document.getElementById(id).classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); document.body.style.overflow = ''; }

    async function loadStats() {
      try {
        const res = await fetch('/api/impact/my-stats', { credentials: 'include' });
        const data = await res.json();
        if (data.stats) {
          myStats = data.stats;
          document.getElementById('statPeople').textContent = formatNumber(myStats.total_people_impacted);
          document.getElementById('statHours').textContent = formatNumber(myStats.total_hours);
          document.getElementById('statUsd').textContent = '$' + formatNumber(myStats.total_usd_value);
          document.getElementById('statScp').textContent = formatNumber(myStats.total_scp);
          document.getElementById('statEvents').textContent = myStats.events_created || 0;
        }
      } catch (err) { console.error('Failed to load stats:', err); }
    }

    async function loadEvents() {
      try {
        const res = await fetch('/api/impact/events', { credentials: 'include' });
        const data = await res.json();
        myEvents = data.events || [];
        document.getElementById('eventsLoading').style.display = 'none';
        if (myEvents.length === 0) { document.getElementById('eventsEmpty').style.display = 'block'; return; }
        document.getElementById('eventsList').style.display = 'block';
        renderEvents(myEvents);
      } catch (err) { console.error('Failed to load events:', err); document.getElementById('eventsLoading').innerHTML = '<p class="text-red-500 text-sm">Failed to load events</p>'; }
    }

    function renderEvents(events) {
      const container = document.getElementById('eventsList');
      container.innerHTML = events.map(event => {
        const catBadge = event.esg_category === 'environmental' ? 'badge-env' : event.esg_category === 'social' ? 'badge-social' : 'badge-gov';
        const statusBadge = event.status === 'open' ? 'badge-open' : 'badge-closed';
        const eventDate = new Date(event.event_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        return `
          <div class="event-card">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <span class="badge ${statusBadge}">${event.status}</span>
                  <span class="badge ${catBadge}">${event.esg_category}</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">${escapeHtml(event.title)}</h3>
                <p class="text-sm text-gray-500 mb-3 line-clamp-2">${escapeHtml(event.description)}</p>
                <div class="flex items-center gap-4 text-xs text-gray-500 flex-wrap">
                  <span><i class="bx bx-calendar mr-1"></i>${eventDate}</span>
                  <span><i class="bx bx-time mr-1"></i>${event.start_time?.slice(0,5)} - ${event.end_time?.slice(0,5)}</span>
                  <span><i class="bx bx-group mr-1"></i>${event.participant_count || 0} participants</span>
                  <span><i class="bx bx-target-lock mr-1"></i>${formatNumber(event.total_impact_value)} ${escapeHtml(event.impact_unit)}</span>
                </div>
              </div>
              <div class="flex flex-wrap gap-2 flex-shrink-0">
                <button onclick="viewEventDetail('${event.event_id}')" class="btn-secondary btn-sm flex items-center gap-1"><i class="bx bx-info-circle"></i> Details</button>
                ${event.status === 'open' ? `
                  <button onclick="shareEventInvite('${event.event_id}')" class="btn-secondary btn-sm flex items-center gap-1"><i class="bx bx-share"></i> Share</button>
                  <button onclick="closeEvent('${event.event_id}')" class="btn-danger btn-sm flex items-center gap-1"><i class="bx bx-lock"></i> Close</button>
                ` : `<button onclick="shareParticipation('${event.event_id}')" class="btn-secondary btn-sm flex items-center gap-1"><i class="bx bx-share-alt"></i> Share</button>`}
              </div>
            </div>
          </div>`;
      }).join('');
    }

    async function loadEntries() {
      try {
        const res = await fetch('/api/impact/entries', { credentials: 'include' });
        const data = await res.json();
        myEntries = data.entries || [];
        document.getElementById('entriesLoading').style.display = 'none';
        if (myEntries.length === 0) { document.getElementById('entriesEmpty').style.display = 'block'; return; }
        document.getElementById('entriesList').style.display = 'block';
        renderEntries(myEntries);
      } catch (err) { console.error('Failed to load entries:', err); document.getElementById('entriesLoading').innerHTML = '<p class="text-red-500 text-sm">Failed to load entries</p>'; }
    }

    function renderEntries(entries) {
      const container = document.getElementById('entriesList');
      container.innerHTML = entries.map(entry => {
        const catBadge = entry.esg_category === 'environmental' ? 'badge-env' : entry.esg_category === 'social' ? 'badge-social' : 'badge-gov';
        const typeLbl = entry.entry_type === 'event_master' ? 'Event Creator' : entry.entry_type === 'event_derived' ? 'Event Participant' : 'Individual';
        const actDate = new Date(entry.activity_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        return `
          <div class="entry-card">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1 flex-wrap">
                  <span class="badge ${catBadge}">${entry.esg_category}</span>
                  <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">${typeLbl}</span>
                  <span class="text-xs text-gray-400">${actDate}</span>
                </div>
                <h4 class="font-semibold text-gray-800 text-sm">${escapeHtml(entry.title)}</h4>
                ${entry.description ? `<p class="text-xs text-gray-500 mt-1 line-clamp-1">${escapeHtml(entry.description)}</p>` : ''}
              </div>
              <div class="text-right flex-shrink-0">
                <p class="text-sm font-bold text-purple-700">${formatNumber(entry.people_impacted)} ${escapeHtml(entry.impact_unit || 'people')}</p>
                <p class="text-xs text-gray-400">SCP: ${formatNumber(entry.scp_earned)}</p>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    async function handleCreateEvent(e) {
      e.preventDefault();
      const form = e.target; const btn = document.getElementById('createEventBtn'); const spinner = document.getElementById('createEventSpinner');
      const formData = new FormData(form); const body = Object.fromEntries(formData.entries());
      btn.disabled = true; spinner.classList.remove('hidden');
      try {
        const res = await fetch('/api/impact/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create event');
        closeModal('createEventModal'); form.reset();
        showToast('Event created successfully!', 'success');
        if (data.event) viewEventDetail(data.event.event_id);
        loadStats(); loadEvents();
      } catch (err) { showToast(err.message, 'error'); }
      finally { btn.disabled = false; spinner.classList.add('hidden'); }
    }

    async function handleCreateEntry(e) {
      e.preventDefault();
      const form = e.target; const btn = document.getElementById('createEntryBtn'); const spinner = document.getElementById('createEntrySpinner');
      const formData = new FormData(form); const body = Object.fromEntries(formData.entries());
      btn.disabled = true; spinner.classList.remove('hidden');
      try {
        const res = await fetch('/api/impact/entries', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to create entry');
        closeModal('createEntryModal'); form.reset();
        showToast('Impact entry logged successfully!', 'success');
        loadStats(); loadEntries();
      } catch (err) { showToast(err.message, 'error'); }
      finally { btn.disabled = false; spinner.classList.add('hidden'); }
    }

    async function viewEventDetail(eventId) {
      openModal('eventDetailModal');
      const content = document.getElementById('eventDetailContent');
      content.innerHTML = '<div class="text-center py-8"><div class="spinner"></div></div>';
      try {
        const res = await fetch(`/api/impact/events/${eventId}`, { credentials: 'include' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        const event = data.event;
        document.getElementById('detailEventTitle').textContent = event.title;
        const eventDate = new Date(event.event_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        const catBadge = event.esg_category === 'environmental' ? 'badge-env' : event.esg_category === 'social' ? 'badge-social' : 'badge-gov';
        const statusBadge = event.status === 'open' ? 'badge-open' : 'badge-closed';
        const participationUrl = event.participation_link || `${window.location.origin}/event-participate.html?event=${eventId}`;
        content.innerHTML = `
          <div class="space-y-5">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="badge ${statusBadge}">${event.status}</span>
              <span class="badge ${catBadge}">${event.esg_category}</span>
              <span class="text-xs text-gray-400">Tier ${event.verification_level?.replace('tier_', '') || '2'} Verified</span>
            </div>
            <p class="text-sm text-gray-600">${escapeHtml(event.description)}</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="bg-purple-50 rounded-lg p-3 text-center"><p class="text-lg font-bold text-purple-700">${formatNumber(event.total_impact_value)}</p><p class="text-xs text-purple-500">${escapeHtml(event.impact_unit)}</p></div>
              <div class="bg-blue-50 rounded-lg p-3 text-center"><p class="text-lg font-bold text-blue-700">${event.participant_count || 0}</p><p class="text-xs text-blue-500">Participants</p></div>
              <div class="bg-green-50 rounded-lg p-3 text-center"><p class="text-lg font-bold text-green-700">${formatNumber(event.hours_contributed || 0)}</p><p class="text-xs text-green-500">Hours</p></div>
              <div class="bg-amber-50 rounded-lg p-3 text-center"><p class="text-lg font-bold text-amber-700">$${formatNumber(event.usd_value || 0)}</p><p class="text-xs text-amber-500">USD Value</p></div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <p class="text-sm text-gray-700"><i class="bx bx-calendar mr-1"></i> ${eventDate}</p>
              <p class="text-sm text-gray-700"><i class="bx bx-time mr-1"></i> ${event.start_time?.slice(0,5)} - ${event.end_time?.slice(0,5)}</p>
            </div>
            ${event.status === 'open' ? `
            <div class="share-panel">
              <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><i class="bx bx-link text-amber-600"></i> Participation Link</h4>
              <div class="flex items-center gap-2 mb-4">
                <input type="text" value="${participationUrl}" class="form-input text-xs flex-1" readonly id="participationUrl_${eventId}">
                <button onclick="copyToClipboard('participationUrl_${eventId}')" class="share-btn share-copy"><i class="bx bx-copy"></i> Copy</button>
              </div>
              <div class="qr-container mb-4" id="qrContainer_${eventId}"></div>
              <div class="flex flex-wrap gap-2">
                <button onclick="shareToLinkedIn('invite', '${eventId}')" class="share-btn share-linkedin"><i class="bx bxl-linkedin"></i> LinkedIn</button>
                <button onclick="shareToX('invite', '${eventId}')" class="share-btn share-x"><i class="bx bxl-twitter"></i> X</button>
              </div>
            </div>
            ` : `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <h4 class="font-semibold text-green-800 mb-1">Event Completed</h4>
              <p class="text-sm text-green-700">Impact distributed to ${event.participant_count || 0} participants.</p>
              ${event.participant_count > 0 ? `<p class="text-sm text-green-600">Per participant: ${formatNumber(event.total_impact_value / event.participant_count)} ${escapeHtml(event.impact_unit)}</p>` : ''}
            </div>`}
            <div>
              <h4 class="font-semibold text-gray-800 mb-2">Participants (${event.participant_count || 0})</h4>
              ${(event.participants || []).length > 0 ? `
                <div class="space-y-2 max-h-48 overflow-y-auto">${event.participants.map(p => `
                    <div class="flex items-center gap-2 text-sm bg-gray-50 rounded-lg px-3 py-2">
                      <div class="w-7 h-7 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0"><i class="bx bx-user text-purple-600 text-sm"></i></div>
                      <span class="text-gray-700">${p.participant_type === 'user' ? 'Platform User' : (escapeHtml(p.display_name) || 'Anonymous')}</span>
                      <span class="text-xs text-gray-400 ml-auto">${new Date(p.created_at).toLocaleDateString()}</span>
                    </div>`).join('')}
                </div>` : '<p class="text-sm text-gray-400">No participants yet.</p>'}
            </div>
          </div>`;
        if (event.status === 'open') {
          const qrContainer = document.getElementById(`qrContainer_${eventId}`);
          if (qrContainer && typeof QRCode !== 'undefined') {
            const canvas = document.createElement('canvas');
            qrContainer.appendChild(canvas);
            QRCode.toCanvas(canvas, participationUrl, { width: 180, margin: 2, color: { dark: '#4b0d7f' } });
          }
        }
      } catch (err) { content.innerHTML = `<p class="text-red-500 text-sm">${err.message}</p>`; }
    }

    async function closeEvent(eventId) {
      if (!confirm('Close this event? Impact will be distributed to all participants. This cannot be undone.')) return;
      try {
        const res = await fetch(`/api/impact/events/${eventId}/close`, { method: 'POST', credentials: 'include' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showToast(data.message || 'Event closed!', 'success');
        loadStats(); loadEvents();
      } catch (err) { showToast(err.message, 'error'); }
    }

    function shareEventInvite(eventId) {
      const event = myEvents.find(e => e.event_id === eventId);
      if (!event) return;
      const url = `${window.location.origin}/event-participate.html?event=${eventId}`;
      const text = `We're hosting "${event.title}" - a community impact event.\nJoin us and be part of something bigger.\n#TransformationLeader #PositiveImpact\n\n`;
      openShareOptions(text, url);
    }
    function shareParticipation(eventId) {
      const text = `Proud to have hosted a community impact event with @TransformationLeader.\nImpact starts with action.\n#TransformationLeader #PositiveImpact`;
      openShareOptions(text, '');
    }
    function openShareMyImpact() {
      const content = document.getElementById('shareMyImpactContent');
      const people = Math.round(myStats.total_people_impacted || 0);
      const hours = Math.round(myStats.total_hours || 0);
      const events = (myStats.events_created || 0) + (myStats.events_participated || 0);
      content.innerHTML = `
        <div class="space-y-5">
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 text-center border border-purple-100">
            <img src="/images/favicon.png" alt="T4L" class="w-10 h-10 mx-auto mb-3 rounded-lg" onerror="this.style.display='none'">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Our Impact with Transformation Leader</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
              <div><p class="text-2xl font-bold text-purple-700">${people > 0 ? people + '+' : '0'}</p><p class="text-xs text-gray-500">People Reached</p></div>
              <div><p class="text-2xl font-bold text-blue-700">${hours}</p><p class="text-xs text-gray-500">Hours</p></div>
              <div><p class="text-2xl font-bold text-green-700">${events}</p><p class="text-xs text-gray-500">Events</p></div>
            </div>
            <p class="text-xs text-gray-400">Positive Impact | Sustainable Change</p>
          </div>
          <div class="flex flex-wrap gap-2 justify-center">
            <button onclick="shareToLinkedIn('personal', null)" class="share-btn share-linkedin"><i class="bx bxl-linkedin"></i> LinkedIn</button>
            <button onclick="shareToX('personal', null)" class="share-btn share-x"><i class="bx bxl-twitter"></i> X</button>
            <button onclick="copyShareText()" class="share-btn share-copy"><i class="bx bx-copy"></i> Copy Text</button>
          </div>
          <p class="text-xs text-gray-400 text-center italic">Social sharing features are promotional and invitational in nature and must not be used as evidence of ESG performance or verification.</p>
        </div>`;
      openModal('shareMyImpactModal');
    }
    function shareToLinkedIn(type, eventId) {
      let text = '', url = '';
      if (type === 'invite' && eventId) {
        const event = myEvents.find(e => e.event_id === eventId);
        url = `${window.location.origin}/event-participate.html?event=${eventId}`;
        text = `We're hosting "${event?.title || 'a community impact event'}" - join us!\n#TransformationLeader #PositiveImpact`;
      } else if (type === 'personal') {
        const people = Math.round(myStats.total_people_impacted || 0);
        text = `Our organization has contributed to community initiatives reaching ${people > 0 ? people + '+ people' : 'multiple communities'} through the Transformation Leader ecosystem.\n#TransformationLeader #PositiveImpact`;
      }
      window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url || window.location.origin)}&text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=500');
    }
    function shareToX(type, eventId) {
      let text = '';
      if (type === 'invite' && eventId) {
        const event = myEvents.find(e => e.event_id === eventId);
        text = `We're hosting "${event?.title || 'an impact event'}" - join us!\n${window.location.origin}/event-participate.html?event=${eventId}\n#TransformationLeader`;
      } else if (type === 'personal') {
        const people = Math.round(myStats.total_people_impacted || 0);
        text = `Our organization has contributed to initiatives reaching ${people > 0 ? people + '+ people' : 'multiple communities'} through @T4Leader.\n#PositiveImpact`;
      }
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');
    }
    function copyShareText() {
      const people = Math.round(myStats.total_people_impacted || 0);
      navigator.clipboard.writeText(`Our organization has contributed to community initiatives reaching ${people > 0 ? people + '+ people' : 'multiple communities'} through the Transformation Leader ecosystem. #TransformationLeader #PositiveImpact`).then(() => showToast('Copied!', 'success'));
    }
    function openShareOptions(text, url) {
      const fullText = url ? text + url : text;
      if (navigator.share) { navigator.share({ text: fullText }).catch(() => {}); }
      else { navigator.clipboard.writeText(fullText).then(() => showToast('Copied!', 'success')); }
    }
    function copyToClipboard(inputId) { const input = document.getElementById(inputId); if (input) navigator.clipboard.writeText(input.value).then(() => showToast('Link copied!', 'success')); }
    function formatNumber(num) { const n = parseFloat(num) || 0; if (n >= 1000000) return (n/1000000).toFixed(1)+'M'; if (n >= 1000) return (n/1000).toFixed(1)+'K'; return Math.round(n * 100) / 100; }
    function escapeHtml(str) { if (!str) return ''; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bg = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-purple-600';
      toast.className = `fixed top-4 right-4 z-[100] ${bg} text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium max-w-sm`;
      toast.style.animation = 'slideUp 0.3s ease'; toast.textContent = message; document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3500);
    }

    // ---- Export Impact Report ----
    function exportImpactReport() {
      if (!myStats || !myStats.category_breakdown) {
        showToast('Loading stats... please try again in a moment.', 'error');
        loadStats();
        return;
      }

      const s = myStats;
      const cat = s.category_breakdown || { environmental: {people:0,hours:0,usd:0}, social: {people:0,hours:0,usd:0}, governance: {people:0,hours:0,usd:0} };
      const ver = s.verification_breakdown || { tier_1: 0, tier_2: 0, tier_3: 0, tier_4: 0 };
      const totalEntries = s.total_entries || 0;
      const t1Pct = totalEntries > 0 ? ((ver.tier_1 / totalEntries) * 100).toFixed(1) : '0.0';
      const t2Pct = totalEntries > 0 ? ((ver.tier_2 / totalEntries) * 100).toFixed(1) : '0.0';
      const t3Pct = totalEntries > 0 ? ((ver.tier_3 / totalEntries) * 100).toFixed(1) : '0.0';
      const t4Pct = totalEntries > 0 ? ((ver.tier_4 / totalEntries) * 100).toFixed(1) : '0.0';
      const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      const fmtNum = (n) => { const v = parseFloat(n) || 0; return v.toLocaleString('en-US', { maximumFractionDigits: 0 }); };
      const fmtUsd = (n) => { const v = parseFloat(n) || 0; return '$' + v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };

      const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Impact Report | Transformation Leader</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #fff; color: #1a1a2e; padding: 48px; max-width: 900px; margin: 0 auto; }
    .header-bar { height: 4px; background: linear-gradient(90deg, #4b0d7f, #7c3aed, #f59e0b); border-radius: 2px; margin-bottom: 32px; }
    h1 { font-size: 32px; font-weight: 800; color: #4b0d7f; margin-bottom: 4px; }
    .subtitle { color: #6b7280; font-size: 14px; margin-bottom: 4px; }
    .period { color: #374151; font-size: 14px; font-weight: 600; margin-bottom: 32px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 40px; }
    .kpi-card { border: 2px solid #e9d5ff; border-radius: 12px; padding: 24px; text-align: center; }
    .kpi-value { font-size: 40px; font-weight: 800; color: #4b0d7f; }
    .kpi-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: #6b7280; margin-top: 4px; }
    h2 { font-size: 22px; font-weight: 700; color: #4b0d7f; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
    th { background: #4b0d7f; color: #fff; padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    th:first-child { border-radius: 8px 0 0 0; }
    th:last-child { border-radius: 0 8px 0 0; }
    td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; }
    tr:last-child td { border-bottom: none; }
    .disclosure { margin-top: 40px; padding-top: 24px; border-top: 2px solid #e9d5ff; }
    .disclosure h2 { font-size: 20px; margin-bottom: 12px; }
    .disclosure p { font-size: 13px; color: #6b7280; line-height: 1.7; margin-bottom: 8px; }
    .footer { margin-top: 40px; text-align: center; color: #9ca3af; font-size: 12px; }
    .footer .logo-text { font-weight: 700; color: #4b0d7f; }
    @media print {
      body { padding: 24px; }
      .no-print { display: none !important; }
    }
    .print-actions { position: fixed; top: 16px; right: 16px; display: flex; gap: 8px; }
    .print-actions button { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .btn-print { background: #4b0d7f; color: #fff; }
    .btn-print:hover { background: #6b21a8; }
    .btn-close { background: #f3f4f6; color: #374151; }
    .btn-close:hover { background: #e5e7eb; }
  </style>
</head>
<body>
  <div class="print-actions no-print">
    <button class="btn-print" onclick="window.print()">&#128438; Print / Save PDF</button>
    <button class="btn-close" onclick="window.close()">Close</button>
  </div>

  <div class="header-bar"></div>

  <h1>Organization Impact Report</h1>
  <p class="subtitle">Positive Impact | Sustainable Change</p>
  <p class="period">Reporting Period: All time to Present &mdash; Generated ${today}</p>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-value">${fmtNum(s.total_people_impacted)}</div>
      <div class="kpi-label">People Impacted</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">${fmtNum(s.total_hours)}</div>
      <div class="kpi-label">Hours Contributed</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">${fmtUsd(s.total_usd_value)}</div>
      <div class="kpi-label">Social Value Created</div>
    </div>
  </div>

  <h2>ESG Breakdown</h2>
  <table>
    <thead>
      <tr>
        <th>Category</th>
        <th>People</th>
        <th>Hours</th>
        <th>USD Value</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Environmental</td>
        <td>${fmtNum(cat.environmental?.people)}</td>
        <td>${fmtNum(cat.environmental?.hours)}</td>
        <td>${fmtUsd(cat.environmental?.usd)}</td>
      </tr>
      <tr>
        <td>Social</td>
        <td>${fmtNum(cat.social?.people)}</td>
        <td>${fmtNum(cat.social?.hours)}</td>
        <td>${fmtUsd(cat.social?.usd)}</td>
      </tr>
      <tr>
        <td>Governance</td>
        <td>${fmtNum(cat.governance?.people)}</td>
        <td>${fmtNum(cat.governance?.hours)}</td>
        <td>${fmtUsd(cat.governance?.usd)}</td>
      </tr>
    </tbody>
  </table>

  <h2>Verification Transparency</h2>
  <table>
    <thead>
      <tr>
        <th>Tier</th>
        <th>% of Entries</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Tier 1 &ndash; Self-Reported</td>
        <td>${t1Pct}%</td>
      </tr>
      <tr>
        <td>Tier 2 &ndash; Partner Verified</td>
        <td>${t2Pct}%</td>
      </tr>
      <tr>
        <td>Tier 3 &ndash; Externally Audited</td>
        <td>${t3Pct}%</td>
      </tr>
      <tr>
        <td>Tier 4 &ndash; Certified</td>
        <td>${t4Pct}%</td>
      </tr>
    </tbody>
  </table>

  <div class="disclosure">
    <h2>Methodology &amp; Disclosure</h2>
    <p>Impact entries may be self-reported (Tier 1) or supported by partner validation and/or evidence (Tier 2+). USD social value figures are estimated by the reporting organization and are not independently audited. "People Impacted" reflects the cumulative reach of activities logged by this organization through the Transformation Leader platform.</p>
    <p>This report is generated for organizational reference and transparent impact tracking. It is not an audited ESG performance document. Social sharing of this report is promotional in nature and must not be used as evidence of ESG performance or verification.</p>
  </div>

  <div class="footer">
    <p><span class="logo-text">Transformation Leader</span> &mdash; Positive Impact | Sustainable Change</p>
    <p style="margin-top:4px;">Report generated on ${today}</p>
  </div>
</body>
</html>`;

      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(html);
      reportWindow.document.close();
    }
    </script>
</body>
</html>
