<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <title>Users Feedback &amp; Support | T4LA Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <header class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-bold text-slate-900">Users Feedback &amp; Support</h1>
          <p class="text-sm text-slate-600">
            Review issues, ideas, and questions submitted from the ambassador app.
          </p>
        </div>
        <a
          href="/admin-dashboard.html"
          class="inline-flex items-center gap-1 text-sm text-purple-700 hover:text-purple-900 font-medium"
        >
          ← Back to Admin Dashboard
        </a>
      </header>

      <section
        id="feedbackContainer"
        class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 space-y-3"
      >
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-lg bg-purple-100 text-purple-700">
              <i class="bx bx-message-dots text-lg"></i>
            </span>
            Inbox
          </h2>
          <span id="feedbackCount" class="text-xs text-slate-500"></span>
        </div>

        <div id="feedbackList" class="divide-y divide-slate-100">
          <div class="py-8 text-center text-slate-400 text-sm" id="feedbackEmpty">
            <p>No feedback yet. Your ambassadors are quiet (for now)!</p>
          </div>
        </div>
      </section>
    </div>

    <!-- Feedback Details Modal -->
    <div
      id="feedbackModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6 relative"
      >
        <button
          id="feedbackModalClose"
          class="absolute top-3 right-3 text-slate-400 hover:text-slate-600"
        >
          <i class="bx bx-x text-2xl"></i>
        </button>
        <div class="mb-4">
          <h2
            id="feedbackModalTitle"
            class="text-lg font-semibold text-slate-900 mb-1"
          >
          </h2>
          <p
            id="feedbackModalMeta"
            class="text-xs text-slate-500"
          ></p>
        </div>
        <div class="mb-4">
          <h3 class="text-xs font-semibold text-slate-500 uppercase mb-1">
            Message
          </h3>
          <p
            id="feedbackModalMessage"
            class="text-sm text-slate-700 whitespace-pre-wrap"
          ></p>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="feedbackModalStatus" class="text-xs"></div>
          <a
            id="feedbackModalScreenshot"
            href="#"
            target="_blank"
            class="hidden inline-flex items-center gap-1 text-xs text-purple-700 hover:text-purple-900"
          >
            <i class="bx bx-image-alt text-sm"></i>
            View screenshot
          </a>
        </div>
      </div>
    </div>

    <script>
      async function ensureAdmin() {
        try {
          const res = await fetch('/api/me', { credentials: 'include' });
          if (!res.ok) throw new Error('unauth');
          const me = await res.json();
          if (!me || me.role !== 'admin') {
            window.location.href = '/admin-signin.html';
          }
        } catch {
          window.location.href = '/admin-signin.html';
        }
      }
      ensureAdmin();

      const feedbackList = document.getElementById('feedbackList');
      const feedbackEmpty = document.getElementById('feedbackEmpty');
      const feedbackCount = document.getElementById('feedbackCount');
      const feedbackModal = document.getElementById('feedbackModal');
      const feedbackModalClose = document.getElementById('feedbackModalClose');
      const feedbackModalTitle = document.getElementById('feedbackModalTitle');
      const feedbackModalMeta = document.getElementById('feedbackModalMeta');
      const feedbackModalMessage = document.getElementById('feedbackModalMessage');
      const feedbackModalStatus = document.getElementById('feedbackModalStatus');
      const feedbackModalScreenshot = document.getElementById('feedbackModalScreenshot');

      let feedbackItems = [];

      function formatDateTime(value) {
        if (!value) return '-';
        try {
          return new Date(value).toLocaleString();
        } catch {
          return value;
        }
      }

      function renderStatusBadge(status) {
        const s = String(status || 'open').toLowerCase();
        if (s === 'resolved' || s === 'closed') {
          return '<span class="px-2 py-0.5 text-[11px] rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Resolved</span>';
        }
        if (s === 'in_progress') {
          return '<span class="px-2 py-0.5 text-[11px] rounded-full bg-amber-50 text-amber-700 border border-amber-100">In progress</span>';
        }
        return '<span class="px-2 py-0.5 text-[11px] rounded-full bg-sky-50 text-sky-700 border border-sky-100">New</span>';
      }

      function renderItem(item) {
        const cat =
          {
            bug: 'Bug',
            idea: 'Idea',
            content: 'Content',
            other: 'Other',
          }[item.category] || 'Other';

        const title = item.subject || `${cat} from ${item.role || 'user'}`;
        const hasScreenshot = !!item.screenshot_filename;
        const screenshotUrl = hasScreenshot
          ? '/uploads/support/' + encodeURIComponent(item.screenshot_filename)
          : null;

        return `
          <article class="py-3 flex flex-col gap-2 sm:flex-row sm:items-start sm:gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2 justify-between">
                <div class="min-w-0">
                  <h3 class="text-sm font-semibold text-slate-900 truncate">
                    ${title}
                  </h3>
                  <p class="text-xs text-slate-500 mt-0.5">
                    ${cat} • ${item.role || 'user'} • ${formatDateTime(item.created_at)}
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  ${renderStatusBadge(item.status)}
                  <button
                    type="button"
                    class="feedback-open-btn inline-flex items-center px-3 py-1 rounded-full border border-sky-200 text-xs font-semibold text-sky-700 bg-sky-50 hover:bg-sky-100 transition-colors"
                    data-feedback-id="${item.feedback_id}"
                  >
                    Open
                  </button>
                  ${
                    hasScreenshot
                      ? `<a href="${screenshotUrl}" target="_blank" class="inline-flex items-center px-3 py-1 rounded-full border border-indigo-200 text-xs font-semibold text-indigo-700 bg-indigo-50 hover:bg-indigo-100 transition-colors">
                           <i class="bx bx-image-alt text-sm mr-1"></i>
                           View image
                         </a>`
                      : ""
                  }
                </div>
              </div>
              <p class="mt-2 text-sm text-slate-700 line-clamp-3 whitespace-pre-wrap">
                ${item.message || ''}
              </p>
            </div>
          </article>
        `;
      }

      function openFeedbackModal(item) {
        if (!item) return;

        const cat =
          {
            bug: 'Bug',
            idea: 'Idea',
            content: 'Content',
            other: 'Other',
          }[item.category] || 'Other';

        feedbackModalTitle.textContent =
          item.subject || `${cat} from ${item.role || 'user'}`;
        feedbackModalMeta.textContent = `${cat} • ${
          item.role || 'user'
        } • ${formatDateTime(item.created_at)}`;
        feedbackModalMessage.textContent = item.message || '';
        feedbackModalStatus.innerHTML = renderStatusBadge(item.status);

        if (item.screenshot_filename) {
          feedbackModalScreenshot.href =
            '/uploads/support/' +
            encodeURIComponent(item.screenshot_filename);
          feedbackModalScreenshot.classList.remove('hidden');
        } else {
          feedbackModalScreenshot.classList.add('hidden');
        }

        feedbackModal.classList.remove('hidden');
      }

      function closeFeedbackModal() {
        feedbackModal.classList.add('hidden');
      }

      feedbackModalClose.addEventListener('click', closeFeedbackModal);
      feedbackModal.addEventListener('click', (e) => {
        if (e.target === feedbackModal) {
          closeFeedbackModal();
        }
      });

      async function loadFeedback() {
        try {
          const res = await fetch('/admin/api/support-feedback', {
            credentials: 'include',
          });
          const data = await res.json();
          const items = data.items || [];
          feedbackItems = items;

          if (!items.length) {
            feedbackEmpty.classList.remove('hidden');
            feedbackList.innerHTML = '';
            feedbackList.appendChild(feedbackEmpty);
            feedbackCount.textContent = '0 items';
            return;
          }

          feedbackEmpty.classList.add('hidden');
          feedbackList.innerHTML = items.map(renderItem).join('');
          // Attach click handlers for "Open" buttons
          document
            .querySelectorAll('.feedback-open-btn')
            .forEach((btn) => {
              btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-feedback-id');
                const item = feedbackItems.find(
                  (it) => it.feedback_id === id
                );
                openFeedbackModal(item);
              });
            });
          feedbackCount.textContent =
            items.length === 1 ? '1 item' : items.length + ' items';
        } catch (err) {
          console.error('Error loading feedback', err);
          feedbackEmpty.classList.remove('hidden');
          feedbackEmpty.textContent = 'Failed to load feedback. Please refresh.';
        }
      }

      loadFeedback();
    </script>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
  </body>
</html>

