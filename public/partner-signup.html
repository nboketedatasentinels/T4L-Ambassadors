<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T4L Partner Workspace Sign-Up</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      
      /* Loading state for button */
      .btn-loading {
        position: relative;
        color: transparent !important;
      }
      .btn-loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.75s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      /* Error message styling */
      .form-error {
        display: none;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0.5rem;
        background-color: #fee2e2;
        border: 1px solid #fecaca;
        color: #991b1b;
        font-size: 0.875rem;
      }
      .form-error.show {
        display: block;
      }
      .form-error i {
        margin-right: 0.5rem;
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row bg-white shadow-2xl rounded-2xl overflow-hidden w-full max-w-[950px] lg:h-[780px] relative z-10">

      <!-- Left: Form -->
      <div class="w-full lg:w-1/2 flex flex-col justify-center px-8 sm:px-12 py-10 lg:py-12">
        <div class="mb-8">
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2 tracking-tight">
            Create your account
          </h1>
          <p class="text-gray-600 text-sm sm:text-base">
            Join the <span class="font-semibold text-yellow-600">T4L Partner</span> network
          </p>
        </div>

        <!-- Error message container -->
        <div id="form-error-container" class="form-error mb-4">
          <i class="bx bx-error-circle"></i>
          <span id="form-error-message"></span>
        </div>

        <!-- Success message container -->
        <div id="form-success-container" class="form-error mb-4" style="display: none; background-color: #dcfce7; border-color: #bbf7d0; color: #166534;">
          <i class="bx bx-check-circle"></i>
          <span id="form-success-message"></span>
        </div>

        <!-- Form -->
        <form class="space-y-5" id="partner-signup-form">
          
          <!-- Organization Name & Contact Name Side by Side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Organization Name</label>
              <input 
                type="text" 
                name="organizationName"
                placeholder="Your organization" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
                required
              />
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Contact Name</label>
              <input 
                type="text" 
                name="contactName"
                placeholder="Primary contact" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
                required
              />
            </div>
          </div>

          <!-- Email & Phone Side by Side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Email Address</label>
              <input 
                type="email" 
                name="email"
                placeholder="you@organization.com" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
                required
              />
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Phone Number</label>
              <input 
                type="tel" 
                name="phoneNumber"
                placeholder="(555) 123-4567" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
              />
              <input type="hidden" name="phoneNumberRaw" id="phoneNumberRaw">
            </div>
          </div>

          <!-- Location & Partner Type Side by Side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Location</label>
              <input 
                type="text" 
                name="location"
                placeholder="City, Country" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
              />
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Partner Type</label>
              <select 
                name="partnerType"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition bg-white"
              >
                <option value="">Select type</option>
                <option value="corporate">Corporate</option>
                <option value="nonprofit">Non-Profit</option>
                <option value="educational">Educational</option>
                <option value="government">Government</option>
                <option value="community">Community</option>
                <option value="individual">Individual</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <!-- Access Code -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-semibold text-gray-800">Access Code</label>
              <span class="text-[11px] text-gray-500">Request from T4L admin</span>
            </div>
            <input 
              type="text" 
              name="access_code"
              placeholder="T4LP-XXXX" 
              class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition uppercase"
              required
            />
          </div>

          <!-- Password & Confirm Password Side by Side -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Password</label>
              <input 
                type="password" 
                name="password"
                minlength="8"
                placeholder="••••••••" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
                required
              />
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Confirm Password</label>
              <input 
                type="password" 
                name="confirmPassword"
                minlength="8"
                placeholder="••••••••" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none transition"
                required
              />
              <p id="partner-password-error" class="mt-2 text-sm text-red-600 hidden">Passwords do not match.</p>
            </div>
          </div>

          <!-- Terms -->
          <div class="flex items-start gap-3 text-sm pt-2">
            <input type="checkbox" name="terms" id="partner-terms" class="mt-1 w-4 h-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500 cursor-pointer" required />
            <label for="partner-terms" class="text-gray-700">I agree to <a href="#" class="text-yellow-600 hover:text-yellow-700 font-semibold">Terms & Conditions</a></label>
          </div>

          <!-- Submit Button -->
          <button 
            type="submit" 
            id="submitBtn"
            class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-3.5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.01] mt-4 flex items-center justify-center"
          >
            <span id="submitText">Create Partner Account</span>
            <span id="submitSpinner" class="hidden ml-2">
              <svg class="animate-spin h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>

        <!-- Already have an account -->
        <div class="mt-2 pt-3 border-t border-gray-200 text-center">
          <p class="text-sm text-gray-600">
            Already have an account?
            <a href="/partner-signin" class="text-yellow-600 hover:text-yellow-700 font-semibold transition ml-1">Sign in</a>
          </p>
        </div>
      </div>

      <!-- Right: Image -->
      <div class="w-full lg:w-1/2 bg-gradient-to-br from-yellow-50 to-yellow-100 relative h-64 sm:h-80 lg:h-auto overflow-hidden">
        <img 
          src="/images/signin3.jpg" 
          alt="T4L Partner Organizations" 
          class="w-full h-full object-cover opacity-90"
        />
        <div class="absolute inset-0 bg-gradient-to-br from-yellow-600/5 via-transparent to-yellow-900/20"></div>
        <div class="absolute inset-0 flex items-end p-8 sm:p-10">
          <div class="text-white">
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 drop-shadow-lg">Partner with Us</h2>
            <p class="text-sm sm:text-base text-white/90 drop-shadow">Connect with ambassadors to speak, mentor, and volunteer</p>
          </div>
        </div>
      </div>

    </div>

    <!-- Gradient Blobs -->
    <div class="fixed -top-20 -right-20 
      w-64 sm:w-72 md:w-96 h-64 sm:h-72 md:h-96 
      bg-gradient-to-tr from-yellow-300 to-yellow-500 
      opacity-30 blur-3xl rounded-full z-0"></div>
    <div class="fixed -bottom-24 -left-24 
      w-64 sm:w-72 md:w-[28rem] h-64 sm:h-72 md:h-[28rem] 
      bg-gradient-to-tr from-purple-200 to-purple-400 
      opacity-30 blur-3xl rounded-full z-0"></div>

    <!-- Boxicons for error/success icons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <script>
      (function() {
        const form = document.getElementById('partner-signup-form');
        const errorEl = document.getElementById('partner-password-error');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');
        const formErrorContainer = document.getElementById('form-error-container');
        const formErrorMessage = document.getElementById('form-error-message');
        const formSuccessContainer = document.getElementById('form-success-container');
        const formSuccessMessage = document.getElementById('form-success-message');
        const phoneInput = form.querySelector('input[name="phoneNumber"]');
        const phoneRawInput = document.getElementById('phoneNumberRaw');
        
        // Hide error/success messages initially
        formErrorContainer.classList.remove('show');
        formSuccessContainer.style.display = 'none';
        
        function showError(message) {
          formErrorMessage.textContent = message;
          formErrorContainer.classList.add('show');
          formSuccessContainer.style.display = 'none';
          
          // Scroll to error message
          formErrorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function showSuccess(message) {
          formSuccessMessage.textContent = message;
          formSuccessContainer.style.display = 'block';
          formErrorContainer.classList.remove('show');
        }
        
        function hideMessages() {
          formErrorContainer.classList.remove('show');
          formSuccessContainer.style.display = 'none';
        }
        
        function setLoading(isLoading) {
          if (isLoading) {
            submitBtn.disabled = true;
            submitText.textContent = 'Creating Account...';
            submitSpinner.classList.remove('hidden');
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
          } else {
            submitBtn.disabled = false;
            submitText.textContent = 'Create Partner Account';
            submitSpinner.classList.add('hidden');
            submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
          }
        }
        
        // Store raw phone number before formatting
        phoneInput.addEventListener('input', function(e) {
          const rawValue = e.target.value.replace(/\D/g, '');
          phoneRawInput.value = rawValue;
          
          // Auto-format phone number for display
          let formattedValue = rawValue;
          if (rawValue.length > 0) {
            if (rawValue.length <= 3) {
              formattedValue = `(${rawValue}`;
            } else if (rawValue.length <= 6) {
              formattedValue = `(${rawValue.slice(0, 3)}) ${rawValue.slice(3)}`;
            } else {
              formattedValue = `(${rawValue.slice(0, 3)}) ${rawValue.slice(3, 6)}-${rawValue.slice(6, 10)}`;
            }
          }
          e.target.value = formattedValue;
        });
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Hide previous messages
          hideMessages();
          
          // Client-side validation
          const pwd = form.querySelector('input[name="password"]').value;
          const confirm = form.querySelector('input[name="confirmPassword"]').value;
          const terms = form.querySelector('input[name="terms"]').checked;
          
          let valid = true;
          let errorMessage = '';
          
          if (pwd !== confirm) {
            errorEl.classList.remove('hidden');
            valid = false;
            errorMessage = 'Passwords do not match.';
          } else {
            errorEl.classList.add('hidden');
          }
          
          if (!terms) {
            valid = false;
            errorMessage = 'Please agree to the Terms & Conditions';
          }
          
          if (!valid) {
            showError(errorMessage);
            return;
          }
          
          // Prepare form data
          const formData = new FormData(form);
          
          // Use raw phone number if available
          if (phoneRawInput.value) {
            formData.set('phoneNumber', phoneRawInput.value);
          }
          
          // Convert to JSON
          const data = {};
          formData.forEach((value, key) => {
            // Skip confirmPassword field when sending to server
            if (key !== 'confirmPassword') {
              data[key] = value;
            }
          });
          
          console.log('Submitting partner registration:', data);
          
          // Set loading state
          setLoading(true);
          
          try {
            const response = await fetch('/register/partner', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            });
            
            if (response.ok) {
              // Success - store auto-populate data
              try {
                const email = form.querySelector('input[name="email"]').value || '';
                const access_code = form.querySelector('input[name="access_code"]').value || '';
                const password = form.querySelector('input[name="password"]').value || '';
                const timestamp = Date.now();
                const autoData = {
                  email: email,
                  access_code: access_code,
                  password: password,
                  timestamp: timestamp
                };
                localStorage.setItem('autoPopulatePartnerEmail', JSON.stringify(autoData));
              } catch (err) {
                console.warn('Could not save auto-populate data:', err);
              }
              
              // Show success message
              showSuccess('Account created successfully! Redirecting to sign in...');
              
              // Redirect after short delay
              setTimeout(() => {
                window.location.href = '/partner-signin?autoPopulate=true';
              }, 2000);
              
            } else {
              // Handle server error
              const errorData = await response.json().catch(() => ({}));
              const errorMsg = errorData.error || errorData.message || `Registration failed (${response.status})`;
              showError(errorMsg);
              setLoading(false);
            }
            
          } catch (error) {
            console.error('Registration error:', error);
            showError('Network error. Please check your connection and try again.');
            setLoading(false);
          }
        });

        // Real-time password validation
        const passwordInput = form.querySelector('input[name="password"]');
        const confirmPasswordInput = form.querySelector('input[name="confirmPassword"]');
        
        function validatePasswords() {
          const pwd = passwordInput.value;
          const confirm = confirmPasswordInput.value;
          
          if (confirm && pwd !== confirm) {
            errorEl.classList.remove('hidden');
            return false;
          } else {
            errorEl.classList.add('hidden');
            return true;
          }
        }
        
        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
        
        // Auto-focus first input field
        const firstInput = form.querySelector('input[type="text"], input[type="email"]');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 100);
        }
      })();
    </script>
  </body>
</html>