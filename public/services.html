<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Services | T4L Partners</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <style>
      .sidebar-toggle { display: none; }
      
      @media (max-width: 768px) {
        .sidebar-toggle {
          display: flex;
          position: fixed;
          top: 1rem;
          left: 1rem;
          z-index: 50;
          background: #4b0d7f;
          color: white;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          position: fixed;
          height: 100vh;
          z-index: 40;
        }
        
        .sidebar.active { transform: translateX(0); }
        
        .overlay {
          display: none;
          position: fixed;
          inset: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 30;
        }
        
        .overlay.active { display: block; }
      }
      
      .service-type-photography { background-color: #f0f9ff; color: #0369a1; border-color: #bae6fd; }
      .service-type-videography { background-color: #f5f3ff; color: #5b21b6; border-color: #c4b5fd; }
      .service-type-graphic-design { background-color: #fef7cd; color: #854d0e; border-color: #fde68a; }
      .service-type-web-development { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
      .service-type-event-production { background-color: #fce7f3; color: #9d174d; border-color: #f9a8d4; }
      .service-type-copywriting { background-color: #e8f4fd; color: #0c4a6e; border-color: #7dd3fc; }
      .service-type-legal-services { background-color: #fef3c7; color: #92400e; border-color: #fde68a; }
      .service-type-accounting { background-color: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; }
      .service-type-other { background-color: #f1f5f9; color: #475569; border-color: #cbd5e1; }
      
      .status-active { background-color: #d1fae5; color: #065f46; }
      .status-closed { background-color: #fef2f2; color: #991b1b; }
      .status-pending { background-color: #fef3c7; color: #92400e; }
      .status-draft { background-color: #f3f4f6; color: #4b5563; }

      /* Toast Animation */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .toast-enter {
        animation: slideInRight 0.3s ease-out;
      }

      .toast-exit {
        animation: slideOutRight 0.3s ease-in;
      }

      /* Loading spinner for request button */
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Global Notification Script -->
    <script src="/js/notifications.js"></script>
    <!-- Global Ambassador Sidebar -->
    <script src="/js/ambassador-sidebar.js"></script>
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="bx bx-menu text-xl"></i>
    </button>
    
    <div class="overlay" id="overlay"></div>
    
    <!-- Success Toast Notification -->
    <div id="successToast" class="hidden fixed top-4 right-4 z-50 bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-md">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
          <i class="bx bx-check text-2xl text-green-600"></i>
        </div>
        <div class="flex-1">
          <h4 class="font-semibold text-gray-900 mb-1">Request Sent Successfully!</h4>
          <p class="text-sm text-gray-600" id="toastMessage">Your service request has been sent to the partner.</p>
        </div>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
          <i class="bx bx-x text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Error Toast Notification -->
    <div id="errorToast" class="hidden fixed top-4 right-4 z-50 bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 max-w-md">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
          <i class="bx bx-error text-2xl text-red-600"></i>
        </div>
        <div class="flex-1">
          <h4 class="font-semibold text-gray-900 mb-1">Request Failed</h4>
          <p class="text-sm text-gray-600" id="errorToastMessage">Something went wrong. Please try again.</p>
        </div>
        <button onclick="hideErrorToast()" class="text-gray-400 hover:text-gray-600">
          <i class="bx bx-x text-xl"></i>
        </button>
      </div>
    </div>
    
    <div class="flex min-h-screen">
      <aside class="sidebar w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-6 z-40">
        <div class="mb-4">
          <div class="bg-[#4b0d7f] text-white px-3 py-2 rounded-xl font-semibold text-sm">T4L</div>
        </div>
        <nav class="flex flex-col space-y-4 text-gray-700 w-full">
          <a href="/ambassador-dashboard.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bxs-home text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Home</span>
          </a>
          <a href="/services.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg bg-purple-50">
            <i class="bx bx-briefcase-alt-2 text-2xl text-[#4b0d9f] group-hover:scale-110 transition-transform duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-[#4b0d9f] transition-colors duration-200">Services</span>
          </a>
          <a href="/article-amb.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-edit-alt text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Publishing</span>
          </a>
          <a href="/journey.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-line-chart text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Impact Log</span>
          </a>
          <a href="/Partner-Calls.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-briefcase text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Partners</span>
          </a>
          <a href="https://www.t4leader.com/event" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-calendar-event text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Events</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-user text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Profile</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-cog text-2xl text-gray-600 group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Settings</span>
          </a>
          <div id="logoutBtn" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-red-50">
            <i class="bx bx-log-out text-2xl text-gray-600 group-hover:text-red-600 group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-red-600 transition-colors duration-200">Logout</span>
          </div>
        </nav>
      </aside>

      <main class="flex-1 p-4 md:p-6 lg:p-6">
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Services Marketplace</h1>
            <p class="text-gray-600 text-sm mt-1">Browse and request services from T4L Partners</p>
          </div>
          <div class="flex items-center space-x-4 w-full md:w-auto">
            <div id="createServiceBtn" class="hidden">
              <a href="/create-service.html" class="bg-[#4b0d7f] hover:bg-[#3a0a66] text-white px-4 py-2.5 rounded-lg font-medium flex items-center gap-2 transition-colors">
                <i class="bx bx-plus"></i>
                Create Service
              </a>
            </div>
            <div id="myServicesBtn" class="hidden">
              <a href="/my-services.html" class="bg-white border border-[#4b0d7f] text-[#4b0d7f] hover:bg-purple-50 px-4 py-2.5 rounded-lg font-medium flex items-center gap-2 transition-colors">
                <i class="bx bx-list-ul"></i>
                My Services
              </a>
            </div>
            <div class="relative flex-1 md:flex-none">
              <input type="text" placeholder="Search services..." class="border border-gray-400 rounded-full pl-10 pr-4 py-2.5 text-sm w-full md:w-80 focus:outline-none focus:ring-2 focus:ring-purple-500" id="searchServices" />
              <i class="bx bx-search absolute left-3 top-3 text-gray-900"></i>
            </div>
            <div class="flex items-center space-x-2">
              <i class="bx bx-bell text-2xl text-gray-900"></i>
              <div class="w-10 h-10 bg-[#4b0d7f] flex items-center justify-center rounded-full font-bold text-white" id="userAvatar">AP</div>
            </div>
          </div>
        </header>

        <div class="bg-white rounded-xl p-4 mb-6 border border-gray-100 shadow-sm">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-2">
              <span class="text-gray-700 font-medium">Filter by:</span>
              <div class="flex flex-wrap gap-2">
                <button class="filter-btn active bg-[#4b0d7f] text-white px-3 py-1.5 rounded-lg text-sm font-medium" data-filter="all">All Services</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="photography">Photography</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="videography">Videography</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="graphic-design">Graphic Design</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="web-development">Web Development</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="event-production">Event Production</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="copywriting">Copywriting</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="legal-services">Legal Services</button>
                <button class="filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors" data-filter="accounting">Accounting</button>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-700 font-medium">Sort by:</span>
              <select id="sortServices" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="recent">Most Recent</option>
                <option value="requests">Most Requested</option>
                <option value="alpha">Alphabetical</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Available Services</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="servicesContainer">
            <div class="text-center py-12 col-span-full">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#4b0d7f] mx-auto"></div>
              <p class="text-gray-500 mt-4">Loading services...</p>
            </div>
          </div>
        </div>

        <div class="hidden" id="noServicesMessage">
          <div class="text-center py-12">
            <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="bx bx-search text-3xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No services found</h3>
            <p class="text-gray-500 max-w-md mx-auto">Try adjusting your filters or search term to find what you're looking for.</p>
          </div>
        </div>

        <!-- Request Service Modal -->
        <div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" id="requestModal">
          <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-900">Request Service</h3>
              <button class="close-modal text-gray-400 hover:text-gray-600">
                <i class="bx bx-x text-2xl"></i>
              </button>
            </div>
            <p class="text-gray-600 mb-6" id="modalServiceName">Request this service?</p>
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Message (Optional)</label>
              <textarea class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Add any specific details or questions..." id="requestMessage"></textarea>
            </div>
            
            <div class="flex gap-3">
              <button class="close-modal flex-1 border border-gray-300 text-gray-700 hover:bg-gray-50 py-3 rounded-lg font-medium transition-colors">Cancel</button>
              <button class="flex-1 bg-[#4b0d7f] hover:bg-[#3a0a66] text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="confirmRequest">
                <span id="requestBtnText">Send Request</span>
                <span id="requestBtnLoading" class="hidden">
                  <i class="bx bx-loader-alt animate-spin mr-2"></i>
                  Sending...
                </span>
              </button>
            </div>
          </div>
        </div>

      </main>
    </div>

    <script>
      const API_URL = '/api';
      let currentUser = null;
      let currentFilter = 'all';
      let currentSort = 'recent';
      let allServices = [];
      let selectedService = null;

      // Toast Functions
      function showToast(message) {
        const toast = document.getElementById('successToast');
        const messageEl = document.getElementById('toastMessage');
        messageEl.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('toast-enter');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          hideToast();
        }, 5000);
      }

      function hideToast() {
        const toast = document.getElementById('successToast');
        toast.classList.add('toast-exit');
        setTimeout(() => {
          toast.classList.add('hidden');
          toast.classList.remove('toast-enter', 'toast-exit');
        }, 300);
      }

      function showErrorToast(message) {
        const toast = document.getElementById('errorToast');
        const messageEl = document.getElementById('errorToastMessage');
        messageEl.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('toast-enter');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          hideErrorToast();
        }, 5000);
      }

      function hideErrorToast() {
        const toast = document.getElementById('errorToast');
        toast.classList.add('toast-exit');
        setTimeout(() => {
          toast.classList.add('hidden');
          toast.classList.remove('toast-enter', 'toast-exit');
        }, 300);
      }

      // Initialize
      async function init() {
        await loadCurrentUser();
        await loadServices();
        setupEventListeners();
      }

      async function loadCurrentUser() {
        try {
          const response = await fetch(`${API_URL}/me`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            currentUser = await response.json();
            updateUIForUser();
          } else {
            window.location.href = '/signin';
          }
        } catch (error) {
          console.error('Error loading user:', error);
          window.location.href = '/signin';
        }
      }

      function updateUIForUser() {
        if (!currentUser) return;
        
        const userAvatar = document.getElementById('userAvatar');
        const createBtn = document.getElementById('createServiceBtn');
        const myServicesBtn = document.getElementById('myServicesBtn');
        
        const initials = (currentUser.name || 'U').substring(0, 2).toUpperCase();
        userAvatar.textContent = initials;
        
        if (currentUser.role === 'partner') {
          createBtn.classList.remove('hidden');
          myServicesBtn.classList.remove('hidden');
        }
      }

      async function loadServices() {
        try {
          const response = await fetch(`${API_URL}/services`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            allServices = data.services || [];
            renderServices();
          } else {
            console.error('Failed to load services');
            showNoServices();
          }
        } catch (error) {
          console.error('Error loading services:', error);
          showNoServices();
        }
      }

      function renderServices() {
        const container = document.getElementById('servicesContainer');
        const noServicesMsg = document.getElementById('noServicesMessage');
        
        let filteredServices = allServices.filter(service => {
          if (currentFilter === 'all') return true;
          return service.type === currentFilter;
        });
        
        const searchTerm = document.getElementById('searchServices').value.toLowerCase();
        if (searchTerm) {
          filteredServices = filteredServices.filter(service => 
            service.title.toLowerCase().includes(searchTerm) ||
            service.description.toLowerCase().includes(searchTerm)
          );
        }
        
        filteredServices.sort((a, b) => {
          if (currentSort === 'alpha') {
            return a.title.localeCompare(b.title);
          } else if (currentSort === 'requests') {
            return (b.requestCount || 0) - (a.requestCount || 0);
          } else {
            return new Date(b.created_at) - new Date(a.created_at);
          }
        });
        
        if (filteredServices.length === 0) {
          container.innerHTML = '';
          noServicesMsg.classList.remove('hidden');
          return;
        }
        
        noServicesMsg.classList.add('hidden');
        
        container.innerHTML = filteredServices.map(service => `
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow service-card" data-id="${service.service_id}">
            <div class="p-5">
              <div class="flex justify-between items-start mb-3">
                <span class="service-type-${service.type} px-3 py-1 rounded-full text-xs font-medium border">
                  ${formatServiceType(service.type)}
                </span>
                <span class="status-${service.status} px-3 py-1 rounded-full text-xs font-medium">
                  ${service.status === 'active' ? 'Open' : 'Closed'}
                </span>
              </div>
              <h3 class="font-bold text-lg text-gray-900 mb-2">${service.title}</h3>
              <p class="text-gray-600 text-sm mb-4 line-clamp-2">${service.description}</p>
              
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                    <i class="bx bx-user text-purple-600"></i>
                  </div>
                  <span class="text-sm font-medium">Partner</span>
                </div>
                <div class="text-right">
                  <div class="text-xs text-gray-500">Requests</div>
                  <div class="font-semibold">${service.requestCount || 0}</div>
                </div>
              </div>
              
              ${service.status === 'active' && !service.hasRequested ? `
                <button class="request-service-btn w-full bg-[#4b0d7f] hover:bg-[#3a0a66] text-white py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2" data-id="${service.service_id}">
                  <i class="bx bx-send"></i>
                  Request Service
                </button>
              ` : service.hasRequested ? `
                <button class="w-full bg-gray-300 text-gray-600 py-2.5 rounded-lg font-medium cursor-not-allowed" disabled>
                  <i class="bx bx-check"></i>
                  Already Requested
                </button>
              ` : `
                <button class="w-full bg-gray-300 text-gray-600 py-2.5 rounded-lg font-medium cursor-not-allowed" disabled>
                  <i class="bx bx-x"></i>
                  Not Accepting Requests
                </button>
              `}
            </div>
          </div>
        `).join('');
        
        attachServiceCardListeners();
      }

      function formatServiceType(type) {
        return type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }

      function attachServiceCardListeners() {
        document.querySelectorAll('.request-service-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const serviceId = this.dataset.id;
            selectedService = allServices.find(s => s.service_id === serviceId);
            if (selectedService) {
              showRequestModal(selectedService);
            }
          });
        });
      }

      function showRequestModal(service) {
        const modal = document.getElementById('requestModal');
        const modalServiceName = document.getElementById('modalServiceName');
        
        modalServiceName.textContent = `Request "${service.title}"? The service provider will be notified.`;
        modal.classList.remove('hidden');
        document.getElementById('requestMessage').value = '';
        
        // Reset button state
        const confirmBtn = document.getElementById('confirmRequest');
        const btnText = document.getElementById('requestBtnText');
        const btnLoading = document.getElementById('requestBtnLoading');
        
        confirmBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }

      async function submitServiceRequest() {
        if (!selectedService || !currentUser) return;
        
        const message = document.getElementById('requestMessage').value;
        const confirmBtn = document.getElementById('confirmRequest');
        const btnText = document.getElementById('requestBtnText');
        const btnLoading = document.getElementById('requestBtnLoading');
        
        // Disable button and show loading
        confirmBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        
        try {
          const response = await fetch(`${API_URL}/services/${selectedService.service_id}/request`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
              message: message
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            
            // Close modal
            document.getElementById('requestModal').classList.add('hidden');
            
            // Show success toast
            showToast(`Your request for "${selectedService.title}" has been sent successfully! The partner will be notified.`);
            
            // Reload services to update UI
            await loadServices();
            
          } else {
            const error = await response.json();
            showErrorToast(error.error || 'Failed to send request. Please try again.');
          }
        } catch (error) {
          console.error('Error submitting request:', error);
          showErrorToast('Network error. Please check your connection and try again.');
        } finally {
          // Re-enable button
          confirmBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
      }

      function setupEventListeners() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');
        
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.add('active');
            overlay.classList.add('active');
          });
        }
        
        if (overlay) {
          overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
          });
        }
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => {
              b.classList.remove('active', 'bg-[#4b0d7f]', 'text-white');
              b.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            this.classList.remove('bg-gray-100', 'text-gray-700');
            this.classList.add('active', 'bg-[#4b0d7f]', 'text-white');
            
            currentFilter = this.dataset.filter;
            renderServices();
          });
        });
        
        document.getElementById('searchServices').addEventListener('input', () => {
          renderServices();
        });
        
        document.getElementById('sortServices').addEventListener('change', function() {
          currentSort = this.value;
          renderServices();
        });
        
        document.querySelectorAll('.close-modal').forEach(btn => {
          btn.addEventListener('click', () => {
            document.getElementById('requestModal').classList.add('hidden');
            // Reset modal state
            document.getElementById('requestMessage').value = '';
            document.getElementById('confirmRequest').disabled = false;
            document.getElementById('requestBtnText').classList.remove('hidden');
            document.getElementById('requestBtnLoading').classList.add('hidden');
          });
        });
        
        document.getElementById('confirmRequest').addEventListener('click', submitServiceRequest);
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            document.getElementById('requestModal').classList.add('hidden');
          }
        });
        
        // Close modal when clicking outside
        document.getElementById('requestModal').addEventListener('click', (e) => {
          if (e.target.id === 'requestModal') {
            document.getElementById('requestModal').classList.add('hidden');
          }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          try {
            await fetch(`${API_URL}/logout`, {
              method: 'POST',
              credentials: 'include'
            });
            window.location.href = '/signin';
          } catch (error) {
            console.error('Logout error:', error);
            window.location.href = '/signin';
          }
        });
      }

      function showNoServices() {
        const container = document.getElementById('servicesContainer');
        container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Failed to load services. Please try again.</div>';
      }

      init();
    </script>
  </body>
</html>