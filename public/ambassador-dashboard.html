<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T4L Ambassador Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for mobile sidebar toggle */
      .sidebar-toggle {
        display: none;
      }
      
      @media (max-width: 768px) {
        .sidebar-toggle {
          display: block;
          position: fixed;
          top: 1rem;
          left: 1rem;
          z-index: 50;
          background: #4b0d7f;
          color: white;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          position: fixed;
          height: 100vh;
          z-index: 40;
        }
        
        .sidebar.active {
          transform: translateX(0);
        }
        
        .overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 30;
        }
        
        .overlay.active {
          display: block;
        }
      }
      
      /* Add line clamp utility */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      /* Video specific styles */
      .video-preview {
        transition: all 0.3s ease;
      }
      
      .video-preview:hover {
        transform: scale(1.02);
      }
      
      .play-button {
        transition: all 0.3s ease;
      }
      
      .play-button:hover {
        transform: scale(1.1);
      }
      
      /* Loading animation */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Global Notification Script -->
    <script src="/js/notifications.js"></script>
    <!-- Global Ambassador Sidebar -->
    <script src="/js/ambassador-sidebar.js"></script>
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="bx bx-menu text-xl"></i>
    </button>
    
    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay"></div>
    
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="sidebar w-20 lg:w-20 md:w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-6 z-40">
        <div class="mb-4">
          <div class="bg-[#4b0d7f] text-white px-3 py-2 rounded-xl font-semibold text-sm">T4L</div>
        </div>
        <nav class="flex flex-col space-y-4 text-gray-700 w-full">
          <a href="/ambassador-dashboard.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50 bg-purple-50">
            <i class="bx bxs-home text-2xl text-[#4b0d9f] group-hover:scale-110 transition-transform duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-[#4b0d9f] transition-colors duration-200">Home</span>
          </a>
          <a href="/article-amb.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-edit-alt text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Publishing</span>
          </a>
          <a href="/media-library.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-image text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Media Kit</span>
          </a>
          <a href="/Impactlog.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-line-chart text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">ImpactLog</span>
          </a>
          <a href="/Partner-Calls.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-briefcase text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Partners</span>
          </a>
        <a href="/services.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
          <i class="bx bx-briefcase-alt-2 text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
          <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Services</span>
        </a>
          <a href="https://www.t4leader.com/event" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-calendar-event text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Events</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-user text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Profile</span>
          </a>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-cog text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Settings</span>
          </a>
          <div id="logoutBtn" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-red-50">
            <i class="bx bx-log-out text-2xl group-hover:text-red-600 group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-red-600 transition-colors duration-200">Logout</span>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-4 md:p-6 lg:p-6">
        <!-- Top Navbar -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <h1 class="text-xl font-semibold text-gray-900">T4L Ambassador</h1>
          <div class="flex items-center space-x-4 w-full md:w-auto">
            <div class="relative flex-1 md:flex-none">
              <input
                type="text"
                placeholder="Search articles, events, partners..."
                class="border border-gray-400 rounded-full pl-10 pr-4 py-2 text-sm w-full md:w-80 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              <i class="bx bx-search absolute left-3 top-2.5 text-gray-900"></i>
            </div>
            <div class="flex items-center space-x-3">
              <!-- Notification Bell -->
              <button id="notificationBell" class="relative p-2 rounded-full hover:bg-purple-100 transition-all" title="Notifications">
                <i class="bx bx-bell text-2xl text-gray-900"></i>
              </button>
              <div class="w-10 h-10 bg-[#4b0d7f] flex items-center justify-center rounded-full font-bold text-white" id="userAvatar">
                SM
              </div>
            </div>
          </div>
        </header>

        <!-- Hero Section -->
        <section
          class="bg-gradient-to-r from-[#4b0d7f] to-[#a36737] text-white p-4 md:p-6 rounded-2xl mb-6 shadow-md"
        >
          <h2 class="text-xl md:text-2xl font-semibold mb-2" id="welcomeHeading">Welcome back</h2>
          <p class="text-sm mb-6" id="heroDescription">
            You're in Month 1 <span class="font-semibold">Visibility Stage</span><br />
            There's an opportunity for you to be featured on our next podcast!
          </p>

          <div class="flex flex-col md:flex-row gap-4 items-stretch">
            <div
              class="flex-1 bg-white/20 backdrop-blur-md px-4 md:px-6 py-4 rounded-lg flex flex-col justify-center shadow-sm"
              id="nextMilestoneCard"
            >
              <p class="font-semibold text-sm flex items-center gap-2">
                <i class="bx bx-target-lock text-xl"></i>
                Next Milestone
              </p>
              <p class="text-base mt-1 font-medium" id="nextMilestoneText">Loading...</p>
            </div>

            <div
              class="flex-1 bg-white/20 backdrop-blur-md px-4 md:px-6 py-4 rounded-lg flex flex-col justify-center shadow-sm"
              id="journeyStatsCard"
            >
              <p class="font-semibold text-sm flex items-center gap-2">
                <i class="bx bx-calendar text-xl"></i>
                <span id="daysInProgramLabel">Journey Progress</span>
              </p>
              <p class="text-base mt-1 font-medium" id="daysInProgramText">Loading...</p>
            </div>

            <!-- Join Your Tribe Button -->
            <a href="https://www.youtube.com/@T4Leaders/podcasts"
              class="flex items-center justify-center gap-4 bg-white/20 backdrop-blur-md px-4 md:px-6 py-4 rounded-lg shadow-sm hover:shadow-md transition-all flex-1"
            >
            <i class="bx bx-microphone text-xl"></i>
              <span class="font-medium">Discover Our Podcast Channel</span>
          </a>
          </div>
        </section>

        <!-- Stats -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
          <!-- Journey Progress -->
          <a href="/journey.html"
            class="bg-white border border-purple-300 shadow hover:shadow-2xl rounded-xl p-4 md:p-5 text-center transition-all hover:-translate-y-1 hover:border-purple-500"
          >
            <i class="bx bx-trending-up text-3xl text-purple-600 mx-auto mb-2"></i>
            <p class="font-bold text-black text-lg" id="journeyProgress">25%</p>
            <p class="text-black text-sm">Journey Progress</p>
            <p class="text-black text-xs" id="journeyMonth">Month 3 of 12</p>
        </a>

          <!-- Completed Tasks -->
          <a href="/journey.html"
            class="bg-white border border-green-300 shadow hover:shadow-2xl rounded-xl p-4 md:p-5 text-center transition-all hover:-translate-y-1 hover:border-green-500"
          >
            <i class="bx bx-check-circle text-3xl text-green-600 mx-auto mb-2"></i>
            <p class="font-bold text-black text-lg" id="completedTasksCount">--</p>
            <p class="text-black text-sm">Completed Tasks</p>
            <p class="text-black text-xs" id="upcomingTasksCount">-- upcoming</p>
          </a>

          <!-- Article Due -->
          <a href="/article-amb.html"
            class="bg-white border border-blue-300 shadow hover:shadow-2xl rounded-xl p-4 md:p-5 text-center transition-all hover:-translate-y-1 hover:border-blue-500"
          >
            <i class="bx bx-edit text-3xl text-blue-600 mx-auto mb-2"></i>
            <p class="font-bold text-black text-lg" id="articlesPendingCount">--</p>
            <p class="text-black text-sm">Articles Pending</p>
            <p class="text-black text-xs" id="nextArticleDue">Next due: --</p>
          </a>

          <!-- Partner Application -->
          <a href="/Partner-Calls.html"
            class="bg-white border border-yellow-300 shadow hover:shadow-2xl rounded-xl p-4 md:p-5 text-center transition-all hover:-translate-y-1 hover:border-yellow-500"
          >
            <i class="bx bx-briefcase text-3xl text-yellow-600 mx-auto mb-2"></i>
            <p class="font-bold text-black text-lg" id="applicationsCount">--</p>
            <p class="text-black text-sm">Partner Applications</p>
            <p class="text-black text-xs" id="applicationsStatus">--</p>
          </a>
        </section>

        <!-- Middle Section -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <!-- Video -->
          <div class="bg-white rounded-2xl p-4 md:p-6 lg:col-span-2 border border-gray-100 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-semibold text-gray-900 text-lg" id="videoTitle">This Month's Video</h4>
              <a href="/journey.html" class="text-purple-600 text-sm font-medium hover:text-purple-700 transition-colors">View Journey</a>
            </div>

            <!-- Video Container -->
            <div id="videoContainer" class="rounded-2xl min-h-[16rem] relative overflow-hidden">
              <!-- Loading State -->
              <div class="flex flex-col items-center justify-center h-full bg-gradient-to-br from-purple-50 to-pink-50">
                <div class="animate-pulse flex flex-col items-center">
                  <div class="bg-white rounded-full p-4 mb-4">
                    <i class="bx bx-loader-alt text-3xl text-purple-600 animate-spin"></i>
                  </div>
                  <p class="text-gray-700 font-medium">Loading your video...</p>
                </div>
              </div>
            </div>

            <!-- Video Info -->
            <div class="text-center mt-4">
              <p class="font-semibold text-gray-900" id="videoDescription">Loading...</p>
              <p class="text-sm text-gray-500" id="videoMeta">Preparing your journey content</p>
            </div>


          </div>

          <!-- Events + Partner Calls Column -->
          <div class="flex flex-col gap-6">
            <!-- Events -->
            <div class="bg-white rounded-2xl p-4 md:p-6 border border-gray-100">
              <div class="flex justify-between items-center mb-4">
                <h4 class="font-semibold text-gray-900 text-lg">Tasks</h4>
              </div>
              <div class="space-y-3">
                <!-- Event 1 -->
                <a href="https://www.t4leader.com/ambassador-events" target="_blank" rel="noopener noreferrer" class="block">
                  <div class="border border-gray-200 rounded-2xl p-4 hover:border-purple-300 hover:shadow-sm transition-all cursor-pointer">
                    <div class="flex items-start gap-3">
                      <div class="bg-purple-100 rounded-xl p-2 flex-shrink-0">
                        <i class="bx bxs-group text-purple-600 text-xl"></i>
                      </div>
                      <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm mb-1">Ambassador Events</p>
                      </div>
                    </div>
                  </div>
                </a>

                <!-- Event 2 - Shameless Podcast -->
                <a href="https://cal.com/shameless-podcast-t4l/20-mins-shameless-guest-pre-interview-call?month=2025-11" 
                   target="_blank"
                   renderer="_blank"
                   class="block">
                  <div class="border border-gray-200 rounded-2xl p-4 hover:border-purple-300 hover:shadow-sm transition-all cursor-pointer">
                    <div class="flex items-start gap-3">
                      <div class="bg-purple-100 rounded-xl p-2 flex-shrink-0">
                        <i class="bx bx-microphone text-purple-600 text-xl"></i>
                      </div>
                      <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm mb-1">Shameless Podcast-Booking</p>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            </div>

            <!-- Partner Calls -->
            <div class="bg-white rounded-2xl p-4 md:p-6 border border-gray-100">
              <div class="flex justify-between items-center mb-4">
                <h4 class="font-semibold text-gray-900 text-lg">Partner Calls</h4>
                <a href="/Partner-Calls.html" class="text-purple-600 text-sm font-medium hover:text-purple-700 transition-colors">View all</a>
              </div>
              <div class="space-y-3" id="partnerCallsContainer">
                <!-- Loading state -->
                <div class="flex justify-center items-center py-8">
                  <div class="animate-pulse flex flex-col items-center">
                    <div class="bg-purple-100 rounded-full p-3 mb-2">
                      <i class="bx bx-loader-alt text-2xl text-purple-600 animate-spin"></i>
                    </div>
                    <p class="text-gray-500 text-sm">Loading partner opportunities...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>


      </main>
    </div>

    <!-- External Dashboard Script (Optimized) -->
    <script src="/js/ambassador-dashboard.js"></script>
    <script>
      // ============================================
      // CONFIGURATION DATA - Single Source of Truth
      // ============================================
      const MONTH_CONFIG = [
        { 
          month: 1, title: "FOUNDATION", 
          milestone: "Foundation Set: Onboarding complete, first course done, profile submitted, connections made",
          tasks: ['linkedin_course', 'submit_profile', 'second_course', 'connect_10', 'post_3x'],
          url: "https://www.canva.com/design/DAG1M6MU20c/C1-a9vTfy3AOESPfRhyxfQ/watch?embed",
          description: "Foundation Set: Onboarding complete, first course done",
          duration: "5:30 mins"
        },
        { 
          month: 2, title: "OPTIMIZE",
          milestone: "Optimized Presence: Profile updated, first article submitted, active in community",
          tasks: ['implement_audit', 'third_course', 'submit_article_1', 'engage_15'],
          url: "https://www.canva.com/design/DAGymyxxfQs/vtkXrZ8joa0giowAh60-zg/watch?embed",
          description: "Optimized Presence: Profile updated, first article submitted",
          duration: "6:15 mins"
        },
        { 
          month: 3, title: "ENGAGE",
          milestone: "Engaged Member: Attended event, building relationships, consistent content, impact tracked",
          tasks: ['first_event', 'transformation_post', 'submit_article_2', 'update_impact_log'],
          url: "https://www.canva.com/design/DAGym0x892o/YmDTuaFm1nNjSaJYa93ePA/watch?embed",
          description: "Engaged Member: Building relationships, consistent content",
          duration: "5:45 mins"
        },
        { 
          month: 4, title: "LEAD",
          milestone: "Leadership Activated: Volunteered for opportunity, all courses complete, growing visibility",
          tasks: ['volunteer', 'complete_courses', 'request_recommendation', 'post_4x'],
          url: "https://www.canva.com/design/DAGymzmB9zo/Oz_eCZ8_EDoXnTeseB6R-A/watch?embed",
          description: "Leadership Activated: Growing visibility, all courses complete",
          duration: "7:00 mins"
        },
        { 
          month: 5, title: "AMPLIFY",
          milestone: "Amplified Impact: Led something, article progress, consistent support",
          tasks: ['lead_something', 'check_article', 'daily_engage', 'update_impact_5'],
          url: "https://www.canva.com/design/DAGym1aI8Gw/Sf85oXevN7qOm5zvehr9dQ/watch?embed",
          description: "Amplified Impact: Leading initiatives, consistent support",
          duration: "6:30 mins"
        },
        { 
          month: 6, title: "MIDPOINT",
          milestone: "Halfway Strong: Story shared, podcast scheduled, 50+ people impacted, momentum building",
          tasks: ['quarterly_event_2', 'schedule_podcast', 'halfway_story'],
          url: "https://www.canva.com/design/DAGym9YIUZk/OIRe6vWYWkaZjWLuMomzrg/watch?embed",
          description: "Halfway Strong: Story shared, momentum building",
          duration: "8:00 mins"
        },
        { 
          month: 7, title: "VISIBILITY",
          milestone: "Visible Leader: Podcast prep underway, leading regularly, strong content cadence",
          tasks: ['submit_article_next', 'lead_second', 'post_4x_m7'],
          url: "https://www.canva.com/design/DAGym2_NkFI/NLk8fNcIBNm7mX3lT5mJGQ/watch?embed",
          description: "Visible Leader: Podcast prep, strong content cadence",
          duration: "6:45 mins"
        },
        { 
          month: 8, title: "EXPAND",
          milestone: "Expanded Reach: Podcast recorded/scheduled, applied for external opportunities, portfolio growing",
          tasks: ['check_partners', 'update_speaker', 'speaking_pitch', 'update_impact_8'],
          url: "https://www.canva.com/design/DAGzJ0qBXKM/JeRKp6jCYA88iE3RJBUvGA/watch?embed",
          description: "Expanded Reach: Podcast recorded, portfolio growing",
          duration: "7:15 mins"
        },
        { 
          month: 9, title: "CONNECT",
          milestone: "Connected Leader: Deep relationships built, podcast live, third leadership opportunity completed",
          tasks: ['quarterly_event_3', 'follow_up_5'],
          url: "https://www.canva.com/design/DAGynDXe7nM/XwF5fSUo3GJfpJBR4sO4Vg/watch?embed",
          description: "Connected Leader: Deep relationships, podcast live",
          duration: "6:00 mins"
        },
        { 
          month: 10, title: "ACCELERATE",
          milestone: "Accelerating: Final articles submitted, 85+ impacted, speaking opportunities in pipeline",
          tasks: ['submit_final', 'update_impact_10', 'apply_speaking'],
          url: "https://www.canva.com/design/DAGynMCn0XU/-9LPKLzn5Zc6W5bJS8ktXQ/watch?embed",
          description: "Accelerating: Final articles, opportunities in pipeline",
          duration: "7:30 mins"
        },
        { 
          month: 11, title: "CELEBRATE",
          milestone: "Celebrating: Year documented, story shared, impact quantified",
          tasks: ['quarterly_event_4', 'final_impact', 'transformation_story'],
          url: "https://www.canva.com/design/DAGynKgil_I/FVdnkZFWNsKo1iBsbX7omg/watch?embed",
          description: "Celebrating: Year documented, impact quantified",
          duration: "8:15 mins"
        },
        { 
          month: 12, title: "RENEW",
          milestone: "Transformation Complete: Full year tracked, portfolio built, thought leadership established, decision made",
          tasks: ['decide_renewal', 'schedule_call'],
          url: "https://www.canva.com/design/DAGynMcNxQI/INWdK-bvAm30aMLK45OMfw/watch?embed",
          description: "Transformation Complete: Full year tracked, portfolio built",
          duration: "9:00 mins"
        }
      ];

      function playVideo() {
        try {
          const videoContainer = domCache.get('videoContainer');
          const currentVideo = window.currentVideo;
          
          if (!videoContainer || !currentVideo?.url) {
            showVideoError(videoContainer ? 'Video data is missing. Please refresh the page.' : 'Video container not found.');
            return;
          }
          
          videoContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl min-h-[16rem]">
              <div class="animate-pulse flex flex-col items-center">
                <div class="bg-white rounded-full p-4 mb-4">
                  <i class="bx bx-loader-alt text-3xl text-purple-600 animate-spin"></i>
                </div>
                <p class="text-gray-700 font-medium">Loading video...</p>
              </div>
            </div>
          `;
          
          const playUrl = utils.buildVideoUrl(currentVideo.url);
          const viewUrl = utils.getCanvaViewUrl(currentVideo.url);
          
          setTimeout(() => {
            videoContainer.innerHTML = `
              <div class="relative w-full rounded-2xl overflow-hidden shadow-2xl video-preview" style="padding-top: 56.25%; background: #000;">
                <iframe 
                  id="canvaVideoFrame"
                  class="absolute top-0 left-0 w-full h-full border-0"
                  src="${playUrl}"
                  allow="autoplay *; fullscreen; accelerometer; gyroscope; picture-in-picture; clipboard-write; encrypted-media"
                  allowfullscreen
                  frameborder="0"
                  title="Month ${currentVideo.month}: ${currentVideo.title}"
                  loading="eager"
                  sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation allow-autoplay">
                </iframe>
                <div id="videoLoadingOverlay" class="absolute inset-0 bg-black/50 flex items-center justify-center transition-opacity duration-300">
                  <div class="text-center text-white">
                    <i class="bx bx-loader-alt text-4xl animate-spin mb-2"></i>
                    <p class="text-sm">Loading video player...</p>
                  </div>
                </div>
              </div>
              <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <i class="bx bx-check-circle text-green-600 text-lg mt-0.5"></i>
                  <div class="flex-1">
                    <p class="text-sm text-green-800 font-medium">ðŸŽµ Video is playing automatically with sound!</p>
                    <p class="text-xs text-green-600 mt-1">Use the controls in the video player to pause, adjust volume, or go fullscreen</p>
                    <p class="text-xs text-green-500 mt-2">
                      <a href="${viewUrl}" target="_blank" class="underline hover:text-green-700">Open in Canva <i class="bx bx-link-external text-xs"></i></a>
                    </p>
                  </div>
                </div>
              </div>
            `;
            
            const iframe = document.getElementById('canvaVideoFrame');
            const overlay = document.getElementById('videoLoadingOverlay');
            const hideOverlay = () => {
              if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay?.remove(), 300);
              }
            };
            
            if (iframe) {
              iframe.addEventListener('load', hideOverlay);
              iframe.addEventListener('error', () => showVideoError());
              setTimeout(hideOverlay, 5000);
            }
          }, 100);
        } catch (error) {
          showVideoError(`Error loading video: ${error.message || 'Unknown error'}. Please try again.`);
        }
      }

      // ============================================
      // SHOW VIDEO ERROR STATE
      // ============================================
      function showVideoError(message = null) {
        const videoContainer = document.getElementById('videoContainer');
        const currentVideo = window.currentVideo;
        
        if (videoContainer) {
          const errorMessage = message || 'Unable to load video. Please try again or open the video directly in Canva.';
          const viewUrl = currentVideo?.url ? utils.getCanvaViewUrl(currentVideo.url) : '';
          
          videoContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl min-h-[16rem]">
              <i class="bx bx-error-circle text-5xl text-red-500 mb-4"></i>
              <p class="text-gray-700 font-medium mb-2">Video Loading Error</p>
              <p class="text-gray-500 text-sm text-center mb-4 max-w-md">${errorMessage}</p>
              <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button onclick="loadCurrentMonthVideo()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                  <i class="bx bx-refresh mr-2"></i> Retry
                </button>
                ${viewUrl ? `
                  <a href="${viewUrl}" target="_blank" 
                     class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                    <i class="bx bx-link-external mr-2"></i> Open in Canva
                  </a>
                ` : ''}
              </div>
              <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg max-w-md">
                <p class="text-xs text-yellow-800 text-center">
                  <i class="bx bx-info-circle mr-1"></i>
                  Tip: If videos don't load, check your internet connection and browser settings.
                </p>
              </div>
            </div>
          `;
        }
      }

      // ============================================
      // UTILITY FUNCTIONS
      // ============================================
      const utils = {
        escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },
        
        getPostTypeIcon(postType) {
          const icons = {
            'speaking': 'bx-microphone',
            'podcast': 'bx-podcast',
            'webinar': 'bx-video',
            'volunteering': 'bx-heart',
            'general': 'bx-briefcase'
          };
          return icons[postType?.toLowerCase()] || 'bx-briefcase';
        },
        
        formatDate(dateString) {
          try {
            return new Date(dateString).toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric'
            });
          } catch {
            return 'Recently';
          }
        },
        
        validateVideoUrl(url) {
          if (!url || typeof url !== 'string') return null;
          if (!url.includes('canva.com')) return url;
          if (url.includes('/design/')) {
            url = url.replace('/view?', '/watch?');
            if (!url.includes('/watch')) {
              url = url.replace(/\/design\/([^\/]+)\/([^\/]+)/, '/design/$1/$2').replace('?embed', '/watch?embed');
            }
          }
          return url;
        },
        
        buildVideoUrl(url) {
          if (!url || typeof url !== 'string') throw new Error('Invalid video URL');
          
          if (url.includes('canva.com')) {
            const [baseUrl, existingParams = ''] = url.split('?');
            const params = new URLSearchParams(existingParams);
            if (!params.has('embed')) params.append('embed', '');
            params.set('autoplay', '1');
            params.delete('muted');
            return `${baseUrl}?${params.toString()}`;
          }
          
          return url.includes('?') 
            ? url.replace(/[?&]muted=\d+/g, '').replace(/autoplay=\d+/, 'autoplay=1') + (url.includes('autoplay') ? '' : '&autoplay=1')
            : `${url}?autoplay=1`;
        },
        
        getCanvaViewUrl(url) {
          return url?.replace(/\/watch\?embed/, '/view').replace(/\/watch\?/, '/view?') || url;
        },
        
        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
      };
      
      // ============================================
      // DOM CACHE - Avoid repeated queries
      // ============================================
      const domCache = {
        elements: {},
        get(id) {
          if (!this.elements[id]) {
            this.elements[id] = document.getElementById(id);
          }
          return this.elements[id];
        },
        clear() {
          this.elements = {};
        }
      };


      async function loadCurrentMonthVideo() {
        try {
          const response = await fetch('/api/journey');
          if (!response.ok) throw new Error('Failed to load journey data');
          
          const journeyData = await response.json();
          const currentMonth = Math.max(1, Math.min(12, journeyData.currentMonth || 1));
          const currentVideo = MONTH_CONFIG.find(v => v.month === currentMonth);
          
          if (!currentVideo) throw new Error(`Video configuration missing for month ${currentMonth}`);
          
          const validatedUrl = utils.validateVideoUrl(currentVideo.url);
          if (!validatedUrl) throw new Error(`Invalid video URL for month ${currentMonth}`);
          
          window.currentVideo = { ...currentVideo, url: validatedUrl };
          
          const currentMonthInfo = MONTH_CONFIG.find(m => m.month === currentMonth);
          const nextMonthInfo = MONTH_CONFIG.find(m => m.month === currentMonth + 1);
          
          // Update UI elements using cached DOM
          const heroDesc = domCache.get('heroDescription');
          if (heroDesc && currentMonthInfo) {
            heroDesc.innerHTML = `You're in Month ${currentMonth} <span class="font-semibold">${currentMonthInfo.title} Stage</span><br />${currentMonthInfo.milestone}`;
          }
          
          const nextMilestone = domCache.get('nextMilestoneText');
          if (nextMilestone) {
            nextMilestone.textContent = currentMonth === 12 
              ? "ðŸŽ‰ Journey Complete! Time to Renew"
              : nextMonthInfo ? `Month ${nextMonthInfo.month}: ${nextMonthInfo.title}` : '';
          }
          
          const daysInProgram = domCache.get('daysInProgramText');
          if (daysInProgram) {
            const tasks = journeyData.tasks || {};
            const tasksInMonth = Object.keys(tasks).filter(key => {
              const [monthNum] = key.split('-');
              return parseInt(monthNum) === currentMonth;
            }).length;
            const totalTasks = journeyData.monthTasks?.[currentMonth] || 5;
            const progress = totalTasks > 0 ? Math.round((tasksInMonth / totalTasks) * 100) : 0;
            daysInProgram.textContent = `${progress}% of month tasks completed`;
          }
          
          const videoTitle = domCache.get('videoTitle');
          const videoDesc = domCache.get('videoDescription');
          const videoMeta = domCache.get('videoMeta');
          if (videoTitle) videoTitle.textContent = `Month ${currentMonth}: ${currentVideo.title}`;
          if (videoDesc) videoDesc.textContent = currentVideo.description;
          if (videoMeta) videoMeta.textContent = `${currentVideo.duration} â€¢ Month ${currentMonth}`;
          
          // Auto-play video
          setTimeout(playVideo, 500);
        } catch (error) {
          showVideoError(error.message || 'Failed to load video data. Please refresh the page.');
        }
      }

      async function loadPartnerCalls() {
        try {
          const response = await fetch('/api/posts');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const { posts = [] } = await response.json();
          const container = domCache.get('partnerCallsContainer');
          if (!container) return;
          
          const latestPosts = posts.slice(0, 2);
          
          if (latestPosts.length === 0) {
            container.innerHTML = `
              <div class="text-center py-8">
                <i class="bx bx-info-circle text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-500 text-sm">No partner opportunities available yet</p>
              </div>
            `;
            return;
          }
          
          container.innerHTML = latestPosts.map(post => {
            const formattedDate = utils.formatDate(post.created_at);
            const icon = utils.getPostTypeIcon(post.category);
            const title = utils.escapeHtml(post.title || 'Partner Opportunity');
            const content = utils.escapeHtml(post.content || '');
            
            return `<a href="/Partner-Calls.html" class="block">
              <div class="border border-gray-200 rounded-2xl p-4 hover:border-purple-300 hover:shadow-sm transition-all cursor-pointer">
                <div class="flex items-start gap-3">
                  <div class="bg-purple-100 rounded-xl p-2 flex-shrink-0">
                    <i class="bx ${icon} text-purple-600 text-xl"></i>
                  </div>
                  <div class="flex-1">
                    <p class="font-semibold text-gray-900 text-sm mb-1 truncate">${title}</p>
                    <p class="text-xs text-gray-500 mb-1">${formattedDate} â€¢ ${post.category || 'General'}</p>
                    <p class="text-xs text-gray-600 line-clamp-2">${content}</p>
                  </div>
                </div>
              </div>
            </a>`;
          }).join('');
        } catch (error) {
          const container = domCache.get('partnerCallsContainer');
          if (container) {
            container.innerHTML = `
              <div class="text-center py-8">
                <i class="bx bx-error-circle text-4xl text-red-400 mb-2"></i>
                <p class="text-gray-500 text-sm">Unable to load partner opportunities</p>
                <button onclick="loadPartnerCalls()" class="mt-2 text-purple-600 text-xs font-medium hover:text-purple-700 transition-colors">Try Again</button>
              </div>
            `;
          }
        }
      }


      function loadDashboardStats() {
        try {
          const savedTasks = localStorage.getItem('journey_tasks_default');
          const completedTasks = savedTasks ? JSON.parse(savedTasks) : {};
          
          const getTasksForMonth = (month) => {
            return Object.keys(completedTasks).filter(key => {
              const [monthNum] = key.split('-');
              return parseInt(monthNum) === month && completedTasks[key];
            }).length;
          };
          
          const overallProgress = MONTH_CONFIG.length > 0 
            ? Math.round(MONTH_CONFIG.reduce((acc, m) => {
                return acc + (getTasksForMonth(m.month) / m.tasks.length);
              }, 0) / MONTH_CONFIG.length * 100)
            : 0;
          
          let currentMonth = 1;
          Object.keys(completedTasks).forEach(key => {
            const [monthNum] = key.split('-');
            const month = parseInt(monthNum);
            if (!isNaN(month) && month > currentMonth) currentMonth = month;
          });
          
          const currentMonthData = MONTH_CONFIG.find(m => m.month === currentMonth);
          const currentMonthCompleted = currentMonthData ? getTasksForMonth(currentMonth) : 0;
          const currentMonthTotal = currentMonthData?.tasks.length || 0;
          const upcomingTasks = currentMonthTotal - currentMonthCompleted;
          
          // Update UI using cached DOM
          const journeyProgress = domCache.get('journeyProgress');
          const journeyMonth = domCache.get('journeyMonth');
          const completedTasksCount = domCache.get('completedTasksCount');
          const upcomingTasksCount = domCache.get('upcomingTasksCount');
          const daysInProgramText = domCache.get('daysInProgramText');
          
          if (journeyProgress) journeyProgress.textContent = `${overallProgress}%`;
          if (journeyMonth) journeyMonth.textContent = `Month ${currentMonth} of 12`;
          if (completedTasksCount) completedTasksCount.textContent = currentMonthCompleted;
          if (upcomingTasksCount) upcomingTasksCount.textContent = `${upcomingTasks} remaining`;
          if (daysInProgramText) daysInProgramText.textContent = `Month ${currentMonth} of 12`;
          
          // Load Articles and Applications in parallel
          Promise.all([
            fetch('/api/ambassador/articles?limit=100', { credentials: 'include' }).then(r => r.json()),
            fetch('/api/ambassador/applications', { credentials: 'include' }).then(r => r.json())
          ]).then(([articlesData, appsData]) => {
            const articles = articlesData.items || [];
            const pendingArticles = articles.filter(a => ['pending', 'needs_update', 'draft'].includes(a.status));
            const publishedArticles = articles.filter(a => a.status === 'published');
            
            const articlesPendingCount = domCache.get('articlesPendingCount');
            const nextArticleDue = domCache.get('nextArticleDue');
            
            if (articlesPendingCount) articlesPendingCount.textContent = pendingArticles.length;
            if (nextArticleDue) {
              nextArticleDue.textContent = publishedArticles.length > 0 
                ? `${publishedArticles.length} published`
                : articles.length > 0 
                  ? `${articles.length} total`
                  : 'Write your first!';
            }
            
            const applications = appsData.items || [];
            const pendingApps = applications.filter(a => a.status === 'pending');
            const acceptedApps = applications.filter(a => ['accepted', 'approved'].includes(a.status));
            
            const applicationsCount = domCache.get('applicationsCount');
            const applicationsStatus = domCache.get('applicationsStatus');
            
            if (applicationsCount) applicationsCount.textContent = applications.length;
            if (applicationsStatus) {
              applicationsStatus.textContent = pendingApps.length > 0
                ? `${pendingApps.length} pending review`
                : acceptedApps.length > 0
                  ? `${acceptedApps.length} accepted`
                  : applications.length > 0
                    ? `${applications.length} submitted`
                    : 'Apply to opportunities';
            }
          }).catch(() => {}); // Silently fail
        } catch (err) {
          console.error('Error loading dashboard stats:', err);
        }
      }

      // Debounced version of loadDashboardStats for polling
      const debouncedLoadStats = utils.debounce(loadDashboardStats, 300);
      
      document.addEventListener('DOMContentLoaded', () => {
        // Mobile sidebar toggle
        const sidebarToggle = domCache.get('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = domCache.get('overlay');
        
        if (sidebarToggle && sidebar && overlay) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
          });
          overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
          });
        }

        // Fetch user data - NO REDIRECTS on page load, just update UI if available
        fetch('/api/me', { 
          credentials: 'include',
          headers: {
            'Cache-Control': 'no-cache'
          }
        })
          .then(response => {
            // NO REDIRECTS - just try to get user data if available
            if (!response.ok) {
              // Silently fail - don't redirect, don't throw
              return null;
            }
            return response.json();
          })
          .then(data => {
            if (!data) {
              // No user data - that's okay, just continue
              return;
            }
            
            const welcomeHeading = domCache.get('welcomeHeading');
            const avatarElement = domCache.get('userAvatar');
            
            if (welcomeHeading && data.name) {
              welcomeHeading.textContent = `Welcome back, ${data.name}!`;
            }
            if (avatarElement && data.name) {
              avatarElement.textContent = data.name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            }
          })
          .catch(error => {
            // Silently ignore all errors - NO REDIRECTS on page load
            // User can navigate freely, auth will be checked when needed
          });

        // Logout functionality
        const logoutBtn = domCache.get('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            fetch('/api/logout', { method: 'POST', credentials: 'include' })
              .then(() => window.location.href = '/signin')
              .catch(() => window.location.href = '/signin');
          });
        }

        // Load data in parallel
        Promise.all([
          loadCurrentMonthVideo(),
          loadPartnerCalls()
        ]).then(() => {
          loadDashboardStats();
          
          // Setup efficient polling
          let lastKnownTasks = localStorage.getItem('journey_tasks_default');
          setInterval(() => {
            const currentTasks = localStorage.getItem('journey_tasks_default');
            if (currentTasks !== lastKnownTasks) {
              lastKnownTasks = currentTasks;
              debouncedLoadStats();
            }
          }, 2000);
        });
      });
    </script>
  </body>
</html>sks = currentTasks;
              debouncedLoadStats();
            }
          }, 2000);
        });
      });
    </script>
  </body>
</html>